<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log("DEBUG: DOMContentLoaded event fired. Script execution started.");

    // === ELEMENTI DOM ===
    // È FONDAMENTALE CHE GLI ID QUI SOTTO CORRISPONDANO ESATTAMENTE A QUELLI NEL TUO HTML
    const saveDriverBtn = document.getElementById('saveDriverBtn');
    const addCustomerBtn = document.getElementById('addCustomerBtn');
    const startRoundBtn = document.getElementById('startRoundBtn');
    const downloadReportBtn = document.getElementById('downloadReportBtn'); // JSON
    const downloadCsvReportBtn = document.getElementById('downloadCsvReportBtn');
    const downloadPdfReportBtn = document.getElementById('downloadPdfReportBtn');
    const themeToggleBtn = document.getElementById('themeToggleBtn');

    // Elementi necessari per le funzioni dei pulsanti (elenco parziale per debug)
    const driverNameInput = document.getElementById('driverNameInput');
    const customerListContainer = document.getElementById('customerListContainer');
    const historySearchInput = document.getElementById('historySearchInput');

    console.log("DEBUG: DOM element constants defined.");

    // === VARIABILI GLOBALI DI STATO (Semplificate per debug) ===
    let currentDriver = '';
    let customers = ["", ""]; // Inizializziamo per avere qualcosa da vedere
    let deliveryHistory = [];
    let activeRound = null;
    // WHATSAPP_NUMBER e ADMIN_PASSWORD non sono direttamente coinvolti nel problema dei pulsanti, li ometto per brevità qui

    console.log("DEBUG: Global state variables initialized.");

    // === FUNZIONI HELPER MINIME (Solo quelle indispensabili per i test dei pulsanti) ===
    function showToast(message, type = 'success') {
        console.log(`DEBUG: showToast called - Message: "${message}", Type: "${type}"`);
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            console.error("DEBUG: Toast container not found!");
            return;
        }
        const toast = document.createElement('div');
        toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    function formatDate(dateString) { // Usato da startRoundBtn
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    console.log("DEBUG: Minimal helper functions defined.");

    // === AGGIUNTA EVENT LISTENER CON DEBUG ===

    if (saveDriverBtn) {
        saveDriverBtn.addEventListener('click', () => {
            console.log("DEBUG: 'Salva Fattorino' CLICKED!");
            alert("DEBUG: Pulsante 'Salva Fattorino' premuto!");
            if (!driverNameInput) {
                console.error("DEBUG: driverNameInput non trovato in saveDriverBtn handler");
                return;
            }
            const name = driverNameInput.value.trim();
            if (name) {
                currentDriver = name;
                // updateDriverUI(); // Commentato per semplificare
                // saveAllData(); // Commentato per semplificare
                showToast('Nome fattorino salvato (DEBUG)!');
                console.log("DEBUG: Nome fattorino salvato:", currentDriver);
            } else {
                showToast('Inserisci un nome per il fattorino (DEBUG).', 'error');
            }
        });
        console.log("DEBUG: Event listener per 'saveDriverBtn' AGGIUNTO.");
    } else {
        console.error("DEBUG: 'saveDriverBtn' NON TROVATO nel DOM.");
    }

    if (addCustomerBtn) {
        addCustomerBtn.addEventListener('click', () => {
            console.log("DEBUG: 'Aggiungi Cliente' CLICKED!");
            alert("DEBUG: Pulsante 'Aggiungi Cliente' premuto!");
            customers.push('');
            // renderCustomerInputs(); // Commentato per semplificare
            // saveAllData(); // Commentato per semplificare
            console.log("DEBUG: Cliente aggiunto, ora clienti:", customers);
            showToast('Cliente aggiunto (DEBUG)');
        });
        console.log("DEBUG: Event listener per 'addCustomerBtn' AGGIUNTO.");
    } else {
        console.error("DEBUG: 'addCustomerBtn' NON TROVATO nel DOM.");
    }

    if (startRoundBtn) {
        startRoundBtn.addEventListener('click', () => {
            console.log("DEBUG: 'Inizia Giro' CLICKED!");
            alert("DEBUG: Pulsante 'Inizia Giro' premuto!");
            if (!currentDriver) {
                showToast('Inserisci il nome del fattorino (DEBUG).', 'error');
                if (driverNameInput) driverNameInput.focus();
                return;
            }
            const validCustomers = customers.map(c => c.trim()).filter(c => c !== '');
            if (validCustomers.length === 0) {
                showToast('Inserisci almeno un cliente (DEBUG).', 'error');
                return;
            }
            activeRound = { /* ... dati giro ... */ driverName: currentDriver, customers: validCustomers, startTime: new Date().toISOString() };
            console.log("DEBUG: Giro iniziato:", activeRound);
            showToast('Giro iniziato (DEBUG)!');
            // Il resto della logica (WhatsApp, updateUI, etc.) è omesso per semplicità
        });
        console.log("DEBUG: Event listener per 'startRoundBtn' AGGIUNTO.");
    } else {
        console.error("DEBUG: 'startRoundBtn' NON TROVATO nel DOM.");
    }

    if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', () => {
            console.log("DEBUG: 'Cambia Tema' CLICKED!");
            alert("DEBUG: Pulsante 'Cambia Tema' premuto!");
            // toggleTheme(); // La funzione completa è omessa, ma la logica di base del click dovrebbe funzionare
            document.body.classList.toggle('light-theme'); // Semplice toggle per test
            localStorage.setItem('deliveryManager_theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
            showToast('Tema cambiato (DEBUG)');
        });
        console.log("DEBUG: Event listener per 'themeToggleBtn' AGGIUNTO.");
    } else {
        console.error("DEBUG: 'themeToggleBtn' NON TROVATO nel DOM.");
    }

    // Listener per pulsanti di export (con logica interna semplificata o solo log)
    if (downloadReportBtn) { // JSON
        downloadReportBtn.addEventListener('click', () => {
            console.log("DEBUG: 'JSON Export' CLICKED!");
            alert("DEBUG: Pulsante 'JSON Export' premuto!");
            showToast('Esportazione JSON avviata (DEBUG)');
            // Logica di export omessa per il test del click
        });
        console.log("DEBUG: Event listener per 'downloadReportBtn' (JSON) AGGIUNTO.");
    } else {
        console.error("DEBUG: 'downloadReportBtn' (JSON) NON TROVATO nel DOM.");
    }

    if (downloadCsvReportBtn) {
        downloadCsvReportBtn.addEventListener('click', () => {
            console.log("DEBUG: 'CSV Export' CLICKED!");
            alert("DEBUG: Pulsante 'CSV Export' premuto!");
            showToast('Esportazione CSV avviata (DEBUG)');
            // Logica di export omessa
        });
        console.log("DEBUG: Event listener per 'downloadCsvReportBtn' AGGIUNTO.");
    } else {
        console.error("DEBUG: 'downloadCsvReportBtn' NON TROVATO nel DOM.");
    }
    
    if (downloadPdfReportBtn) {
        downloadPdfReportBtn.addEventListener('click', () => {
            console.log("DEBUG: 'PDF Export' CLICKED!");
            alert("DEBUG: Pulsante 'PDF Export' premuto!");
            
            try {
                if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                    console.error('DEBUG: jsPDF (window.jspdf.jsPDF) non è caricato.');
                    showToast('Libreria PDF (jsPDF) non caricata (DEBUG).', 'error');
                    return;
                }
                const ConstructorJsPDF = window.jspdf.jsPDF;
                const doc = new ConstructorJsPDF();

                if (typeof doc.autoTable !== 'function') {
                    console.error('DEBUG: jsPDF autoTable plugin non è caricato su doc.autoTable.');
                    showToast('Libreria PDF (plugin autoTable) non caricata (DEBUG).', 'error');
                    return;
                }
                console.log("DEBUG: jsPDF e autoTable sembrano caricati per il test PDF.");
                showToast('Esportazione PDF avviata (Librerie OK - DEBUG)');
                // Logica di creazione PDF omessa
            } catch (error) {
                console.error("DEBUG: Errore durante il test del PDF:", error);
                showToast('Errore imprevisto durante il test del PDF (DEBUG).', 'error');
            }
        });
        console.log("DEBUG: Event listener per 'downloadPdfReportBtn' AGGIUNTO.");
    } else {
        console.error("DEBUG: 'downloadPdfReportBtn' NON TROVATO nel DOM.");
    }

    // === INIZIALIZZAZIONE MINIMA (caricamento dati e UI semplificati) ===
    function initialLoad() {
        console.log("DEBUG: Chiamata initialLoad()");
        try {
            // Simuliamo caricamento tema
            const savedTheme = localStorage.getItem('deliveryManager_theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }
            if (themeToggleBtn) themeToggleBtn.innerHTML = `<i class="fas fa-adjust mr-2"></i>Cambia Tema (${savedTheme || 'dark'})`;


            // Visualizza nome fattorino se presente
            currentDriver = localStorage.getItem('deliveryManager_driverName') || '';
            if (driverNameInput) driverNameInput.value = currentDriver; // Mostra nel campo per semplicità
            // Qui normalmente chiameresti updateDriverUI() etc.

            // Statistiche (valori statici per debug)
            const statsTodayRounds = document.getElementById('statsTodayRounds');
            if (statsTodayRounds) statsTodayRounds.textContent = '0 (DEBUG)';
            // ... e così via per le altre statistiche e la cronologia

            console.log("DEBUG: InitialLoad completata.");
        } catch(e) {
            console.error("DEBUG: ERRORE CRITICO in initialLoad:", e);
            alert("ERRORE CRITICO INIZIALIZZAZIONE - Controlla Console (F12)");
        }
    }

    initialLoad(); // Esegui il caricamento iniziale
    console.log("DEBUG: Script principale terminato (listeners dovrebbero essere attivi).");

});
</script>