<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.R. AUTO - Delivery Manager</title>
    <script src="https://cdn.tailwindcss.com"></script> <!-- NOTA: Questo era all'inizio del body nel codice fornito, l'ho lasciato lì, ma spesso Tailwind si usa come CSS compilato -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script> <!-- Aggiunto defer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js" defer></script> <!-- Aggiunto defer -->

    <style>
        :root {
            --bg-main: #2D2D2D;
            --bg-card: #4A4A4A;
            --text-main: #E0E0E0;
            --text-secondary: #B0B0B0;
            --input-bg: #3D3D3D;
            --border-color: #555;
            --accent-blue: #60a5fa; /* Tailwind blue-400 */
        }

        body.light-theme {
            --bg-main: #f3f4f6; /* Tailwind gray-100 */
            --bg-card: #ffffff;
            --text-main: #1f2937; /* Tailwind gray-800 */
            --text-secondary: #4b5563; /* Tailwind gray-600 */
            --input-bg: #e5e7eb; /* Tailwind gray-200 */
            --border-color: #d1d5db; /* Tailwind gray-300 */
            --accent-blue: #3b82f6; /* Tailwind blue-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: background-color 0.3s;
        }
        .input-field {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-radius: 0.375rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        .input-field::placeholder {
            color: var(--text-secondary);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, opacity 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #28a745;
            color: white;
        }
        .btn-primary:hover { background-color: #218838; }
        .btn-secondary {
            background-color: #555;
            color: white;
        }
        body.light-theme .btn-secondary {
            background-color: #e5e7eb; /* gray-200 */
            color: #374151; /* gray-700 */
            border: 1px solid #d1d5db; /* gray-300 */
        }
        body.light-theme .btn-secondary:hover {
             background-color: #d1d5db; /* gray-300 */
        }
        .btn-secondary:hover { background-color: #444; }

        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-neutral { background-color: #6c757d; color: white; }
        .btn-neutral:hover { background-color: #5a6268; }
        body.light-theme .btn-neutral {
            background-color: #d1d5db; /* gray-300 */
            color: #374151; /* gray-700 */
        }
        body.light-theme .btn-neutral:hover {
            background-color: #9ca3af; /* gray-400 */
        }

        .btn-small { padding: 0.5rem 0.75rem; font-size: 0.875rem; }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            left: 20px;
            margin-left: auto;
            margin-right: auto;
            padding: 1rem 1.5rem;
            border-radius: 0.375rem;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.3s ease-in-out;
            max-width: 350px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(20px);
        }
        @media (min-width: 640px) { .toast { left: auto; max-width: 400px; } }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast-success { background-color: #333; }
        .toast-error { background-color: #dc3545; }
        .admin-modal-bg { background-color: rgba(0,0,0,0.7); }
        .badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-warning { background-color: #ffc107; color: #212529; }

        /* Drag and Drop Styles */
        .customer-draggable-item {
            padding: 0.5rem;
            border: 1px dashed var(--border-color);
            border-radius: 0.25rem;
            cursor: grab;
            display: flex;
            align-items: center;
            background-color: var(--input-bg);
        }
        .customer-draggable-item:active { cursor: grabbing; }
        .customer-draggable-item.dragging { opacity: 0.5; background-color: #6c757d; }
        .drag-handle { margin-right: 0.5rem; color: var(--text-secondary); }

        /* Stili per tema chiaro/scuro specifici */
        body.light-theme #openAdminModalLink { color: var(--accent-blue); }
        body.light-theme #openAdminModalLink:hover { color: #2563eb; }
        body.light-theme .text-blue-400 { color: var(--accent-blue); }
        body.light-theme .hover\:text-blue-300:hover { color: #2563eb; }
        body.light-theme .bg-yellow-500 { background-color: #fef9c3; color: #713f12; border: 1px solid #fde047; }
        body.light-theme .text-yellow-900 { color: #713f12; }
        body.light-theme .badge-warning { background-color: #fde047; color: #713f12; }
        body.light-theme .bg-gray-500 { background-color: #e5e7eb; }
        body.light-theme .bg-gray-600 { background-color: #f3f4f6; }
        body.light-theme .text-gray-300 { color: #6b7280; }
        body.light-theme .text-gray-400 { color: #9ca3af; }
        body.light-theme .text-gray-500 { color: #6b7280; }
        
        .file-input-label {
            border: 1px solid var(--border-color);
            display: inline-block;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 0.375rem;
            background-color: var(--input-bg);
            color: var(--text-main);
        }
        .file-input-label:hover {
            background-color: var(--border-color);
        }
        #importFile::file-selector-button { display: none; }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 md:p-8">
    <!-- Lo script Tailwind CDN era qui -->
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <!-- Per produzione, è meglio usare un file CSS compilato da Tailwind -->

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-6 md:mb-8">
            <div class="text-xl sm:text-2xl font-bold mb-1 sm:mb-2">A.R. AUTO SNC CAR PARTS</div>
            <h1 class="text-2xl sm:text-3xl font-bold">A.R. AUTO - Delivery Manager</h1>
            <p class="text-xs sm:text-sm text-gray-400 mb-2">Prodotto da Federico Battistella</p>
            <a href="#" id="openAdminModalLink" class="text-blue-400 hover:text-blue-300 underline text-sm sm:text-base">Accedi alla Dashboard Admin</a>
        </header>

        <main id="mainContent">
            <section id="driverSection" class="card">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-user mr-2"></i>Fattorino</h2>
                <div id="driverInputContainer">
                    <label for="driverNameInput" class="block text-sm font-medium mb-1">Nome Fattorino</label>
                    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                        <input type="text" id="driverNameInput" class="input-field flex-grow mb-2 sm:mb-0" placeholder="Inserisci il tuo nome">
                        <button id="saveDriverBtn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-save"></i> Salva</button>
                    </div>
                </div>
                <div id="driverDisplayContainer" class="hidden items-center">
                    <i class="fas fa-user mr-3 text-xl"></i>
                    <span id="currentDriverName" class="text-lg font-semibold break-all"></span>
                    <button id="editDriverBtn" class="btn btn-secondary ml-auto btn-small"><i class="fas fa-edit"></i> Modifica</button>
                </div>
            </section>

            <div id="activeRoundWarning" class="card bg-yellow-500 text-yellow-900 hidden mb-6 p-3 sm:p-4 flex items-center text-sm sm:text-base">
                <i class="fas fa-sync fa-spin mr-2 sm:mr-3"></i>
                <span>Giro consegne attivo. Completa il giro attuale per avviarne uno nuovo.</span>
            </div>

            <section id="customerInputSection" class="card">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-users mr-2"></i>Inserimento Clienti (Trascina per riordinare)</h2>
                <div id="customerListContainer" class="space-y-2 mb-4">
                    </div>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="addCustomerBtn" class="btn btn-secondary w-full sm:w-auto order-2 sm:order-1"><i class="fas fa-plus"></i> Aggiungi Cliente</button>
                    <button id="startRoundBtn" class="btn btn-primary w-full sm:w-auto order-1 sm:order-2 flex-grow"><i class="fas fa-play"></i> Inizia Giro</button>
                </div>
            </section>

            <section id="activeRoundSection" class="card hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <h2 class="text-lg sm:text-xl font-semibold flex items-center">
                        <i class="fas fa-route mr-2"></i>Giro Consegne Attivo
                    </h2>
                    <span class="badge badge-warning mt-2 sm:mt-0">In corso</span>
                </div>
                
                <div id="editActiveCustomersWarning" class="bg-red-500 text-white p-3 rounded mb-3 text-sm hidden">
                    <i class="fas fa-exclamation-triangle mr-2"></i> Stai modificando i clienti. Il messaggio WhatsApp originale non sarà aggiornato. Salva le modifiche per confermare.
                </div>

                <div class="mb-3">
                    <h3 class="font-medium mb-1 text-sm sm:text-base">Clienti da servire:</h3>
                    <ul id="activeRoundCustomerList" class="list-disc list-inside pl-2 space-y-1 text-sm sm:text-base"></ul>
                    <div id="activeRoundCustomerEditContainer" class="space-y-2 my-2 hidden">
                        </div>
                </div>
                 <div class="flex flex-wrap gap-2 mt-3 mb-3">
                    <button id="toggleEditActiveCustomersBtn" class="btn btn-secondary btn-small"><i class="fas fa-edit mr-1"></i> Modifica Clienti</button>
                    <button id="saveActiveCustomerChangesBtn" class="btn btn-primary btn-small hidden"><i class="fas fa-save mr-1"></i> Salva Modifiche Clienti</button>
                    <button id="cancelActiveCustomerChangesBtn" class="btn btn-danger btn-small hidden"><i class="fas fa-times mr-1"></i> Annulla Modifiche</button>
                </div>

                <div class="space-y-1 text-xs sm:text-sm">
                    <p><i class="fas fa-calendar-alt fa-fw mr-2"></i>Iniziato il: <span id="activeRoundStartTime"></span></p>
                    <p><i class="fas fa-clock fa-fw mr-2"></i>Durata: <span id="activeRoundDuration">00:00:00</span></p>
                    <p><i class="fas fa-shipping-fast fa-fw mr-2"></i>Fattorino: <span id="activeRoundDriverName" class="break-all"></span></p>
                </div>
                <button id="endRoundBtn" class="btn btn-danger mt-6 w-full sm:w-auto"><i class="fas fa-flag-checkered"></i> Giro Concluso</button>
            </section>

            <section id="statsSection" class="card">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-chart-bar mr-2"></i>Statistiche Consegne (Oggi)</h2>
                <div id="dailyStatsContent">
                    <p class="text-sm sm:text-base">Panoramica delle consegne odierne:</p>
                    <ul class="list-disc list-inside pl-2 mt-2 space-y-1 text-xs sm:text-sm">
                        <li>Giri completati oggi: <span id="statsTodayRounds">0</span></li>
                        <li>Clienti serviti oggi: <span id="statsTodayCustomers">0</span></li>
                        <li>Tempo totale consegne oggi: <span id="statsTodayTotalTime">0 ore 0 min</span></li>
                        <li>Tempo medio per giro oggi: <span id="statsTodayAvgTimePerRound">0 min</span></li>
                    </ul>
                </div>
                 <p id="noStatsToday" class="text-gray-400 hidden text-sm sm:text-base">Nessuna statistica disponibile per oggi.</p>
            </section>

            <section id="historySection" class="card">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-history mr-2"></i>Cronologia Consegne</h2>
                
                <div class="mb-4">
                    <label for="historySearchInput" class="block text-sm font-medium mb-1">Cerca nella Cronologia:</label>
                    <input type="text" id="historySearchInput" class="input-field mb-3" placeholder="Nome fattorino, cliente, data (GG/MM/AAAA)...">
                </div>

                <div class="mb-4 flex flex-wrap gap-2">
                    <button id="downloadReportBtn" class="btn btn-neutral text-sm"><i class="fas fa-file-download mr-2"></i>JSON</button>
                    <button id="downloadCsvReportBtn" class="btn btn-neutral text-sm"><i class="fas fa-file-csv mr-2"></i>CSV</button>
                    <button id="downloadPdfReportBtn" class="btn btn-neutral text-sm"><i class="fas fa-file-pdf mr-2"></i>PDF</button>
                </div>
                <div id="deliveryHistoryList" class="space-y-4">
                </div>
                <div id="noHistoryMessage" class="text-center py-6 hidden">
                    <i class="fas fa-box-open fa-3x text-gray-500 mb-3"></i>
                    <p class="text-gray-400 text-sm sm:text-base">Nessuna consegna registrata.</p>
                </div>
            </section>
            
            <section id="settingsSection" class="card">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-cogs mr-2"></i>Impostazioni e Dati</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-medium mb-2">Tema Applicazione</h3>
                        <button id="themeToggleBtn" class="btn btn-secondary w-full"><i class="fas fa-adjust mr-2"></i>Cambia Tema</button>
                    </div>
                    <div>
                        <h3 class="font-medium mb-2">Backup Dati</h3>
                        <div class="flex flex-col gap-2">
                            <button id="exportAllDataBtn" class="btn btn-neutral w-full"><i class="fas fa-file-export mr-2"></i>Esporta Tutti i Dati</button>
                            <div>
                                <label for="importFile" class="file-input-label w-full text-center">
                                    <i class="fas fa-file-import mr-2"></i> Seleziona file per Importo
                                </label>
                                <input type="file" id="importFile" class="hidden" accept=".json">
                            </div>
                            <button id="importAllDataBtn" class="btn btn-neutral w-full mt-1" disabled><i class="fas fa-upload mr-2"></i>Importa Dati Selezionati</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <div id="adminPanel" class="hidden">
             <header class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-3">
                <h1 class="text-xl sm:text-2xl font-bold"><i class="fas fa-shield-alt mr-2"></i>Admin Panel</h1>
                <button id="backToMainViewBtn" class="btn btn-secondary text-sm w-full sm:w-auto"><i class="fas fa-arrow-left mr-1"></i>Torna alla dashboard</button>
            </header>
            <div class="md:flex md:gap-6">
                <aside class="w-full md:w-1/3 lg:w-1/4 card mb-6 md:mb-0">
                    <h3 class="font-semibold mb-3 text-md sm:text-lg">Navigazione</h3>
                    <nav class="space-y-2">
                        <a href="#" data-tab="overview" class="admin-tab block p-2 hover:bg-gray-700 rounded bg-gray-600 text-white text-sm sm:text-base"><i class="fas fa-tachometer-alt fa-fw mr-2"></i>Panoramica</a>
                        <a href="#" data-tab="drivers" class="admin-tab block p-2 hover:bg-gray-700 rounded text-sm sm:text-base"><i class="fas fa-users-cog fa-fw mr-2"></i>Performance Fattorini</a>
                    </nav>
                    <button id="adminLogoutBtn" class="btn btn-danger mt-8 w-full text-sm"><i class="fas fa-sign-out-alt mr-1"></i>Logout</button>
                </aside>
                <main class="w-full md:w-2/3 lg:w-3/4">
                    <div id="adminOverviewTab" class="admin-tab-content card">
                        <h2 class="text-lg sm:text-xl font-semibold mb-4">Panoramica Completa</h2>
                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label for="adminDateFilter" class="block text-sm font-medium mb-1">Filtra per Data (Inizio Giro):</label>
                                <input type="date" id="adminDateFilter" class="input-field text-sm">
                            </div>
                            <div>
                                <label for="adminDriverFilter" class="block text-sm font-medium mb-1">Filtra per Fattorino:</label>
                                <select id="adminDriverFilter" class="input-field text-sm">
                                    <option value="">Tutti i fattorini</option>
                                </select>
                            </div>
                        </div>
                        <button id="applyAdminFiltersBtn" class="btn btn-primary mb-6 w-full sm:w-auto text-sm">Applica Filtri</button>
                        <div class="card bg-gray-600 p-3 sm:p-4 mb-4 text-xs sm:text-sm">
                            <h3 class="font-semibold mb-2 text-sm sm:text-base">Statistiche Generali Filtrate</h3>
                            <div id="adminGeneralStats">
                                <p>Giri totali: <span id="adminTotalRounds">0</span></p>
                                <p>Clienti totali serviti: <span id="adminTotalCustomers">0</span></p>
                                <p>Tempo totale in consegna: <span id="adminTotalDeliveryTime">0h 0m</span></p>
                            </div>
                             <p id="adminNoStats" class="text-gray-400 hidden">Nessuna statistica per i filtri selezionati.</p>
                        </div>
                        <div class="card bg-gray-600 p-3 sm:p-4 mb-4 text-xs sm:text-sm">
                            <h3 class="font-semibold mb-2 text-sm sm:text-base">Consegne in Corso</h3>
                            <div id="adminActiveDeliveries">
                                <p id="adminActiveDeliveryInfo">Nessuna consegna attualmente in corso.</p>
                            </div>
                        </div>
                        <div class="card bg-gray-600 p-3 sm:p-4 text-xs sm:text-sm">
                            <h3 class="font-semibold mb-2 text-sm sm:text-base">Consegne Recenti (ultime 5)</h3>
                            <ul id="adminRecentDeliveriesList" class="list-disc list-inside space-y-1"></ul>
                             <p id="adminNoRecentDeliveries" class="text-gray-400 hidden">Nessuna consegna recente.</p>
                        </div>
                    </div>
                    <div id="adminDriversTab" class="admin-tab-content card hidden">
                        <h2 class="text-lg sm:text-xl font-semibold mb-4">Performance Fattorini</h2>
                        <div id="adminDriverPerformanceList" class="space-y-3"></div>
                        <p id="adminNoDriverData" class="text-gray-400 hidden text-sm sm:text-base">Nessun dato sui fattorini disponibile.</p>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <div id="adminLoginModal" class="fixed inset-0 admin-modal-bg flex items-center justify-center p-4 hidden z-50">
        <div class="card max-w-xs sm:max-w-sm w-full">
            <h2 class="text-lg sm:text-xl font-semibold mb-4 text-center">Accesso Admin</h2>
            <p class="text-xs sm:text-sm text-gray-300 mb-3 text-center">Inserisci la password per accedere.</p>
            <label for="adminPasswordInput" class="block text-sm font-medium mb-1">Password</label>
            <input type="password" id="adminPasswordInput" class="input-field mb-4 text-sm" placeholder="Inserisci la password">
            <div class="flex flex-col sm:flex-row justify-between gap-2 sm:gap-3">
                <button id="cancelAdminLoginBtn" class="btn btn-secondary flex-1 order-2 sm:order-1 text-sm">Annulla</button>
                <button id="submitAdminLoginBtn" class="btn btn-primary flex-1 order-1 sm:order-2 text-sm">Accedi</button>
            </div>
            <p id="adminLoginError" class="text-red-400 text-xs sm:text-sm mt-3 text-center hidden">Password errata.</p>
        </div>
    </div>

    <div id="toastContainer"></div>

<script>
document.addEventListener('DOMContentLoaded', () => { // AVVOLGE TUTTO LO SCRIPT
    // Elementi DOM (aggiunti nuovi elementi)
    const settingsSection = document.getElementById('settingsSection');
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const exportAllDataBtn = document.getElementById('exportAllDataBtn');
    const importFileInput = document.getElementById('importFile');
    const importAllDataBtn = document.getElementById('importAllDataBtn');

    const historySearchInput = document.getElementById('historySearchInput');
    const downloadCsvReportBtn = document.getElementById('downloadCsvReportBtn');
    const downloadPdfReportBtn = document.getElementById('downloadPdfReportBtn');

    const toggleEditActiveCustomersBtn = document.getElementById('toggleEditActiveCustomersBtn');
    const saveActiveCustomerChangesBtn = document.getElementById('saveActiveCustomerChangesBtn');
    const cancelActiveCustomerChangesBtn = document.getElementById('cancelActiveCustomerChangesBtn');
    const activeRoundCustomerEditContainer = document.getElementById('activeRoundCustomerEditContainer');
    const editActiveCustomersWarning = document.getElementById('editActiveCustomersWarning');


    // Elementi DOM esistenti
    const driverSection = document.getElementById('driverSection');
    const driverInputContainer = document.getElementById('driverInputContainer');
    const driverNameInput = document.getElementById('driverNameInput');
    const saveDriverBtn = document.getElementById('saveDriverBtn');
    const driverDisplayContainer = document.getElementById('driverDisplayContainer');
    const currentDriverName = document.getElementById('currentDriverName');
    const editDriverBtn = document.getElementById('editDriverBtn');
    const activeRoundWarning = document.getElementById('activeRoundWarning');
    const customerInputSection = document.getElementById('customerInputSection');
    const customerListContainer = document.getElementById('customerListContainer');
    const addCustomerBtn = document.getElementById('addCustomerBtn');
    const startRoundBtn = document.getElementById('startRoundBtn');
    const activeRoundSection = document.getElementById('activeRoundSection');
    const activeRoundCustomerList = document.getElementById('activeRoundCustomerList');
    const activeRoundStartTime = document.getElementById('activeRoundStartTime');
    const activeRoundDuration = document.getElementById('activeRoundDuration');
    const activeRoundDriverName = document.getElementById('activeRoundDriverName');
    const endRoundBtn = document.getElementById('endRoundBtn');
    const statsSection = document.getElementById('statsSection');
    const dailyStatsContent = document.getElementById('dailyStatsContent');
    const noStatsToday = document.getElementById('noStatsToday');
    const statsTodayRounds = document.getElementById('statsTodayRounds');
    const statsTodayCustomers = document.getElementById('statsTodayCustomers');
    const statsTodayTotalTime = document.getElementById('statsTodayTotalTime');
    const statsTodayAvgTimePerRound = document.getElementById('statsTodayAvgTimePerRound');
    const historySection = document.getElementById('historySection');
    const downloadReportBtn = document.getElementById('downloadReportBtn');
    const deliveryHistoryList = document.getElementById('deliveryHistoryList');
    const noHistoryMessage = document.getElementById('noHistoryMessage');
    const openAdminModalLink = document.getElementById('openAdminModalLink');
    const adminLoginModal = document.getElementById('adminLoginModal');
    const adminPasswordInput = document.getElementById('adminPasswordInput');
    const cancelAdminLoginBtn = document.getElementById('cancelAdminLoginBtn');
    const submitAdminLoginBtn = document.getElementById('submitAdminLoginBtn');
    const adminLoginError = document.getElementById('adminLoginError');
    const mainContent = document.getElementById('mainContent');
    const adminPanel = document.getElementById('adminPanel');
    const backToMainViewBtn = document.getElementById('backToMainViewBtn');
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');
    const adminTabs = document.querySelectorAll('.admin-tab');
    const adminTabContents = document.querySelectorAll('.admin-tab-content');
    const adminDateFilter = document.getElementById('adminDateFilter');
    const adminDriverFilter = document.getElementById('adminDriverFilter');
    const applyAdminFiltersBtn = document.getElementById('applyAdminFiltersBtn');
    const adminTotalRounds = document.getElementById('adminTotalRounds');
    const adminTotalCustomers = document.getElementById('adminTotalCustomers');
    const adminTotalDeliveryTime = document.getElementById('adminTotalDeliveryTime');
    const adminNoStats = document.getElementById('adminNoStats');
    const adminActiveDeliveries = document.getElementById('adminActiveDeliveries');
    const adminActiveDeliveryInfo = document.getElementById('adminActiveDeliveryInfo');
    const adminRecentDeliveriesList = document.getElementById('adminRecentDeliveriesList');
    const adminNoRecentDeliveries = document.getElementById('adminNoRecentDeliveries');
    const adminDriverPerformanceList = document.getElementById('adminDriverPerformanceList');
    const adminNoDriverData = document.getElementById('adminNoDriverData');

    const WHATSAPP_NUMBER = '393939393799';
    const ADMIN_PASSWORD = 'admin';

    let currentDriver = '';
    let customers = []; // Clienti per il prossimo giro
    let activeRound = null;
    let deliveryHistory = [];
    let activeRoundInterval;
    let draggedItem = null; // Per drag and drop
    let isEditingActiveCustomers = false;
    let tempActiveCustomers = []; // Per modifiche non salvate ai clienti attivi


    // --- FUNZIONI HELPER ---
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) { // Aggiunto controllo per sicurezza
            console.error("Toast container not found!");
            return;
        }
        const toast = document.createElement('div');
        toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }
    
    function showInteractiveToast(mainMessage, copyableMessage, type = 'success') {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            console.error("Toast container not found!");
            return;
        }
        const toast = document.createElement('div');
        toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'} flex flex-col sm:flex-row items-center gap-2 sm:gap-3`;
        const messageP = document.createElement('p');
        messageP.textContent = mainMessage;
        messageP.className = 'flex-grow text-sm text-left';
        const copyBtn = document.createElement('button');
        copyBtn.innerHTML = '<i class="fas fa-copy mr-1"></i> Copia Messaggio';
        copyBtn.className = 'btn btn-secondary btn-small flex-shrink-0 w-full sm:w-auto';
        copyBtn.onclick = async () => {
            const success = await copyTextToClipboard(copyableMessage);
            if (success) {
                copyBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Copiato!';
                copyBtn.disabled = true;
                setTimeout(() => {
                    if (toast.parentElement) {
                         copyBtn.innerHTML = '<i class="fas fa-copy mr-1"></i> Copia Messaggio';
                         copyBtn.disabled = false;
                    }
                }, 2500);
            } else {
                copyBtn.innerHTML = '<i class="fas fa-times mr-1"></i> Copia Fallita';
                 setTimeout(() => {
                    if (toast.parentElement) {
                         copyBtn.innerHTML = '<i class="fas fa-copy mr-1"></i> Copia Messaggio';
                         copyBtn.disabled = false;
                    }
                }, 2500);
            }
        };
        toast.appendChild(messageP);
        toast.appendChild(copyBtn);
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 7000);
    }

    async function copyTextToClipboard(text) {
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                return true;
            } else {
                return fallbackCopyTextToClipboard(text);
            }
        } catch (err) {
            console.error('Errore clipboard: ', err);
            return fallbackCopyTextToClipboard(text);
        }
    }

    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.top = "-9999px";
        textArea.style.left = "-9999px";
        textArea.style.width = "1px";
        textArea.style.height = "1px";
        textArea.style.opacity = "0";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            if (!successful) showToast('Impossibile copiare.', 'error');
            document.body.removeChild(textArea);
            return successful;
        } catch (err) {
            console.error('Fallback copia errore: ', err);
            showToast('Impossibile copiare.', 'error');
            document.body.removeChild(textArea);
            return false;
        }
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day}/${month}/${year} ${hours}:${minutes}`;
    }
    
    function formatDuration(ms) {
        if (ms < 0) ms = 0;
        let seconds = Math.floor((ms / 1000) % 60);
        let minutes = Math.floor((ms / (1000 * 60)) % 60);
        let hours = Math.floor((ms / (1000 * 60 * 60)) % 24);
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function formatDurationForDisplay(totalMinutes) {
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        return `${hours} ore ${minutes} min`;
    }

    // --- GESTIONE DATI (localStorage) ---
    function loadAllData() {
        currentDriver = localStorage.getItem('deliveryManager_driverName') || '';
        
        const activeRoundData = localStorage.getItem('deliveryManager_activeRound');
        activeRound = (activeRoundData && activeRoundData !== 'null') ? JSON.parse(activeRoundData) : null;
        
        const historyData = localStorage.getItem('deliveryManager_deliveryHistory');
        deliveryHistory = historyData ? JSON.parse(historyData) : [];
        
        const customersData = localStorage.getItem('deliveryManager_customers');
        customers = customersData ? JSON.parse(customersData) : [];

        loadTheme();
        updateUI();
    }

    function saveAllData() {
        localStorage.setItem('deliveryManager_driverName', currentDriver);
        if (activeRound) {
            localStorage.setItem('deliveryManager_activeRound', JSON.stringify(activeRound));
        } else {
            localStorage.removeItem('deliveryManager_activeRound');
        }
        localStorage.setItem('deliveryManager_deliveryHistory', JSON.stringify(deliveryHistory));
        localStorage.setItem('deliveryManager_customers', JSON.stringify(customers));
    }
    
    function updateUI() {
        updateDriverUI();
        updateActiveRoundUI();
        renderCustomerInputs();
        renderHistoryList();
        updateDailyStats();
        if (adminPanel && !adminPanel.classList.contains('hidden')) { // Aggiunto controllo per adminPanel
            loadAdminData();
        }
    }


    // --- TEMA ---
    function applyTheme(theme) {
        if (theme === 'light') {
            document.body.classList.add('light-theme');
            if (themeToggleBtn) themeToggleBtn.innerHTML = '<i class="fas fa-moon mr-2"></i> Tema Scuro';
        } else {
            document.body.classList.remove('light-theme');
            if (themeToggleBtn) themeToggleBtn.innerHTML = '<i class="fas fa-sun mr-2"></i> Tema Chiaro';
        }
    }

    function toggleTheme() {
        const currentTheme = localStorage.getItem('deliveryManager_theme') || 'dark';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('deliveryManager_theme', newTheme);
        applyTheme(newTheme);
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem('deliveryManager_theme') || 'dark';
        applyTheme(savedTheme);
    }
    if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);

    // --- BACKUP E RIPRISTINO ---
    if (exportAllDataBtn) exportAllDataBtn.addEventListener('click', () => {
        const dataToExport = {
            driverName: currentDriver,
            activeRound: activeRound,
            deliveryHistory: deliveryHistory,
            customers: customers
        };
        const dataStr = JSON.stringify(dataToExport, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = `delivery_manager_backup_${new Date().toISOString().slice(0,10)}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        linkElement.remove();
        showToast('Dati esportati con successo!');
    });

    let importedFileContent = null;
    if (importFileInput) importFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                importedFileContent = e.target.result;
                if (importAllDataBtn) importAllDataBtn.disabled = false;
                showToast(`File "${file.name}" pronto per l'importazione.`, 'success');
            };
            reader.onerror = () => {
                showToast('Errore nella lettura del file.', 'error');
                importedFileContent = null;
                if (importAllDataBtn) importAllDataBtn.disabled = true;
            }
            reader.readAsText(file);
        } else {
            importedFileContent = null;
            if (importAllDataBtn) importAllDataBtn.disabled = true;
        }
    });

    if (importAllDataBtn) importAllDataBtn.addEventListener('click', () => {
        if (!importedFileContent) {
            showToast('Nessun file selezionato per l'importazione.', 'error');
            return;
        }
        try {
            const importedData = JSON.parse(importedFileContent);
            if (typeof importedData.driverName !== 'undefined' &&
                typeof importedData.activeRound !== 'undefined' &&
                Array.isArray(importedData.deliveryHistory) &&
                Array.isArray(importedData.customers) ) {

                currentDriver = importedData.driverName || '';
                activeRound = importedData.activeRound || null;
                deliveryHistory = importedData.deliveryHistory || [];
                customers = importedData.customers || [];

                saveAllData();
                loadAllData();
                showToast('Dati importati con successo!');
            } else {
                showToast('File di backup non valido o corrotto.', 'error');
            }
        } catch (error) {
            console.error("Errore importazione dati:", error);
            showToast('Errore durante l\'importazione dei dati. Assicurati che il file sia JSON valido.', 'error');
        }
        importedFileContent = null;
        if (importAllDataBtn) importAllDataBtn.disabled = true;
        if (importFileInput) importFileInput.value = '';
    });


    // --- UI FATTOINO ---
    function updateDriverUI() {
        if (!driverInputContainer || !driverDisplayContainer || !currentDriverName || !driverNameInput) return; // Controllo esistenza elementi
        if (currentDriver) {
            driverInputContainer.classList.add('hidden');
            driverDisplayContainer.classList.remove('hidden');
            driverDisplayContainer.classList.add('flex');
            currentDriverName.textContent = currentDriver;
        } else {
            driverInputContainer.classList.remove('hidden');
            driverDisplayContainer.classList.add('hidden');
            driverDisplayContainer.classList.remove('flex');
            driverNameInput.value = '';
        }
    }
    if (saveDriverBtn) saveDriverBtn.addEventListener('click', () => {
        if (!driverNameInput) return;
        const name = driverNameInput.value.trim();
        if (name) {
            currentDriver = name;
            updateDriverUI();
            saveAllData();
            showToast('Nome fattorino salvato!');
        } else {
            showToast('Inserisci un nome per il fattorino.', 'error');
        }
    });
    if (editDriverBtn) editDriverBtn.addEventListener('click', () => {
        if (!driverNameInput || !driverInputContainer || !driverDisplayContainer) return;
        driverNameInput.value = currentDriver;
        driverInputContainer.classList.remove('hidden');
        driverDisplayContainer.classList.add('hidden');
        driverDisplayContainer.classList.remove('flex');
        driverNameInput.focus();
    });

    // --- UI CLIENTI (con Drag & Drop) ---
    function renderCustomerInputs() {
        if (!customerListContainer) return;
        customerListContainer.innerHTML = '';
        if (customers.length === 0 && !activeRound) {
             customers = ["", ""];
        }
        customers.forEach((customerName, index) => {
            const div = document.createElement('div');
            div.className = 'customer-draggable-item flex items-center gap-2';
            div.setAttribute('draggable', true);
            div.dataset.index = index;

            div.innerHTML = `
                <i class="fas fa-grip-vertical drag-handle"></i>
                <input type="text" class="input-field customer-input flex-grow text-sm sm:text-base" placeholder="Cliente ${index + 1}" value="${customerName}" data-index="${index}">
                ${customers.length > 1 ? `<button class="btn btn-danger p-2 text-xs sm:text-sm remove-customer-btn" data-index="${index}" aria-label="Rimuovi cliente ${index + 1}"><i class="fas fa-trash"></i></button>` : ''}
            `;
            customerListContainer.appendChild(div);

            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragend', handleDragEnd);
        });

        customerListContainer.addEventListener('dragover', handleDragOver);
        customerListContainer.addEventListener('drop', handleDrop);
        
        document.querySelectorAll('.customer-input').forEach(input => {
            input.addEventListener('change', (e) => {
                customers[parseInt(e.target.dataset.index)] = e.target.value.trim();
                saveAllData();
            });
             input.addEventListener('input', (e) => {
                customers[parseInt(e.target.dataset.index)] = e.target.value;
            });
        });
        document.querySelectorAll('.remove-customer-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const targetButton = e.target.closest('.remove-customer-btn');
                if (!targetButton) return;
                const indexToRemove = parseInt(targetButton.dataset.index);
                customers.splice(indexToRemove, 1);
                if (customers.length === 0) customers.push("");
                renderCustomerInputs();
                saveAllData();
            });
        });
    }

    function handleDragStart(e) {
        draggedItem = e.target.closest('.customer-draggable-item');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedItem.dataset.index);
        setTimeout(() => {
            if(draggedItem) draggedItem.classList.add('dragging');
        }, 0);
    }

    function handleDragEnd(e) {
        if(draggedItem) {
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        }
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }

    function handleDrop(e) {
        e.preventDefault();
        if (!draggedItem) return;

        const targetItem = e.target.closest('.customer-draggable-item');
        const draggedIndex = parseInt(draggedItem.dataset.index);
        let targetIndex;

        if (targetItem) {
            targetIndex = parseInt(targetItem.dataset.index);
        } else {
            targetIndex = customers.length -1;
        }
        
        const [movedCustomer] = customers.splice(draggedIndex, 1);
        customers.splice(targetIndex, 0, movedCustomer);

        renderCustomerInputs();
        saveAllData();
    }

    if (addCustomerBtn) addCustomerBtn.addEventListener('click', () => {
        customers.push('');
        renderCustomerInputs();
        saveAllData();
        const allCustomerInputs = customerListContainer.querySelectorAll('.customer-input');
        if (allCustomerInputs.length > 0) {
            allCustomerInputs[allCustomerInputs.length - 1].focus();
        }
    });

    // --- UI GIRO ATTIVO (con modifica clienti) ---
    function updateActiveRoundUI() {
        if (!activeRoundWarning || !customerInputSection || !activeRoundSection || !endRoundBtn ||
            !activeRoundDriverName || !activeRoundStartTime || !activeRoundDuration ) return;

        if (activeRound) {
            activeRoundWarning.classList.remove('hidden');
            customerInputSection.classList.add('hidden');
            activeRoundSection.classList.remove('hidden');
            endRoundBtn.disabled = isEditingActiveCustomers;

            activeRoundDriverName.textContent = activeRound.driverName;
            activeRoundStartTime.textContent = formatDate(activeRound.startTime);
            
            renderActiveCustomerList();

            clearInterval(activeRoundInterval);
            activeRoundInterval = setInterval(() => {
                const durationMs = new Date() - new Date(activeRound.startTime);
                activeRoundDuration.textContent = formatDuration(durationMs);
            }, 1000);
            const initialDurationMs = new Date() - new Date(activeRound.startTime);
            activeRoundDuration.textContent = formatDuration(initialDurationMs);

        } else {
            activeRoundWarning.classList.add('hidden');
            customerInputSection.classList.remove('hidden');
            activeRoundSection.classList.add('hidden');
            clearInterval(activeRoundInterval);
            exitEditActiveCustomersMode();
        }
    }
    
    function renderActiveCustomerList() {
        if(!activeRoundCustomerList) return;
        activeRoundCustomerList.innerHTML = '';
        if(activeRound && activeRound.customers) {
            activeRound.customers.forEach(customer => {
                const li = document.createElement('li');
                li.innerHTML = `<i class="fas fa-user-tag fa-fw mr-1 text-gray-300"></i> <span class="break-all">${customer}</span>`;
                activeRoundCustomerList.appendChild(li);
            });
        }
    }

    function renderActiveCustomerEditInputs() {
        if(!activeRoundCustomerEditContainer) return;
        activeRoundCustomerEditContainer.innerHTML = '';
        tempActiveCustomers.forEach((customerName, index) => {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.innerHTML = `
                <input type="text" class="input-field active-customer-edit-input flex-grow text-sm" value="${customerName}" data-index="${index}">
                <button class="btn btn-danger btn-small remove-active-customer-btn" data-index="${index}" aria-label="Rimuovi cliente ${index + 1}"><i class="fas fa-trash"></i></button>
            `;
            activeRoundCustomerEditContainer.appendChild(div);
        });
        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-secondary btn-small mt-2';
        addBtn.innerHTML = '<i class="fas fa-plus mr-1"></i> Aggiungi Cliente al Giro';
        addBtn.onclick = () => {
            tempActiveCustomers.push("");
            renderActiveCustomerEditInputs();
        };
        activeRoundCustomerEditContainer.appendChild(addBtn);

        document.querySelectorAll('.active-customer-edit-input').forEach(input => {
            input.addEventListener('input', (e) => {
                tempActiveCustomers[parseInt(e.target.dataset.index)] = e.target.value;
            });
        });
        document.querySelectorAll('.remove-active-customer-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const targetButton = e.target.closest('.remove-active-customer-btn');
                if (!targetButton) return;
                const indexToRemove = parseInt(targetButton.dataset.index);
                tempActiveCustomers.splice(indexToRemove, 1);
                renderActiveCustomerEditInputs();
            });
        });
    }
    
    function enterEditActiveCustomersMode() {
        if (!activeRoundCustomerList || !activeRoundCustomerEditContainer || !toggleEditActiveCustomersBtn ||
            !saveActiveCustomerChangesBtn || !cancelActiveCustomerChangesBtn || !editActiveCustomersWarning || !endRoundBtn) return;
        isEditingActiveCustomers = true;
        tempActiveCustomers = [...activeRound.customers];
        activeRoundCustomerList.classList.add('hidden');
        activeRoundCustomerEditContainer.classList.remove('hidden');
        renderActiveCustomerEditInputs();

        toggleEditActiveCustomersBtn.classList.add('hidden');
        saveActiveCustomerChangesBtn.classList.remove('hidden');
        cancelActiveCustomerChangesBtn.classList.remove('hidden');
        editActiveCustomersWarning.classList.remove('hidden');
        endRoundBtn.disabled = true;
    }

    function exitEditActiveCustomersMode() {
        if (!activeRoundCustomerList || !activeRoundCustomerEditContainer || !toggleEditActiveCustomersBtn ||
            !saveActiveCustomerChangesBtn || !cancelActiveCustomerChangesBtn || !editActiveCustomersWarning || !endRoundBtn) return;
        isEditingActiveCustomers = false;
        activeRoundCustomerList.classList.remove('hidden');
        activeRoundCustomerEditContainer.classList.add('hidden');
        activeRoundCustomerEditContainer.innerHTML = '';

        toggleEditActiveCustomersBtn.classList.remove('hidden');
        saveActiveCustomerChangesBtn.classList.add('hidden');
        cancelActiveCustomerChangesBtn.classList.add('hidden');
        editActiveCustomersWarning.classList.add('hidden');
        if (activeRound) endRoundBtn.disabled = false;
    }

    if (toggleEditActiveCustomersBtn) toggleEditActiveCustomersBtn.addEventListener('click', () => {
        if (activeRound) {
            enterEditActiveCustomersMode();
        }
    });

    if (saveActiveCustomerChangesBtn) saveActiveCustomerChangesBtn.addEventListener('click', () => {
        if (activeRound) {
            const updatedCustomers = tempActiveCustomers.map(c => c.trim()).filter(c => c !== "");
            if (updatedCustomers.length === 0) {
                showToast('Devi avere almeno un cliente nel giro attivo.', 'error');
                return;
            }
            activeRound.customers = updatedCustomers;
            saveAllData();
            renderActiveCustomerList();
            exitEditActiveCustomersMode();
            showToast('Clienti del giro attivo aggiornati.', 'success');
        }
    });
    
    if (cancelActiveCustomerChangesBtn) cancelActiveCustomerChangesBtn.addEventListener('click', () => {
        exitEditActiveCustomersMode();
        renderActiveCustomerList();
    });


    if (startRoundBtn) startRoundBtn.addEventListener('click', () => {
        if (!currentDriver) {
            showToast('Inserisci il nome del fattorino.', 'error');
            if (driverNameInput) driverNameInput.focus();
            return;
        }
        const validCustomers = customers.map(c => c.trim()).filter(c => c !== '');
        if (validCustomers.length === 0) {
            showToast('Inserisci almeno un cliente.', 'error');
            if (customerListContainer) {
                const firstEmptyCustomerInput = Array.from(customerListContainer.querySelectorAll('.customer-input')).find(input => !input.value.trim());
                if (firstEmptyCustomerInput) firstEmptyCustomerInput.focus();
                else if (customerListContainer.querySelector('.customer-input')) customerListContainer.querySelector('.customer-input').focus();
            }
            return;
        }

        activeRound = {
            id: `round_${new Date().getTime()}`,
            driverName: currentDriver,
            customers: validCustomers,
            startTime: new Date().toISOString(),
            status: 'attivo'
        };

        customers = ["", ""];
        renderCustomerInputs();
        updateActiveRoundUI();
        saveAllData();
        updateDailyStats();

        const startTimeFormatted = formatDate(activeRound.startTime);
        let messageContent = `INIZIO GIRO CONSEGNE\nFattorino: ${activeRound.driverName}\nData e Ora Partenza: ${startTimeFormatted}\nClienti da servire:\n`;
        validCustomers.forEach(c => messageContent += `- ${c}\n`);
        messageContent = messageContent.trim();
        
        const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(messageContent)}`;
        window.open(whatsappUrl, '_blank');
        showInteractiveToast('Giro iniziato! WhatsApp si apre...', messageContent);
    });

    if (endRoundBtn) endRoundBtn.addEventListener('click', () => {
        if (!activeRound || isEditingActiveCustomers) return;

        activeRound.endTime = new Date().toISOString();
        activeRound.status = 'concluso';
        const durationMs = new Date(activeRound.endTime) - new Date(activeRound.startTime);
        activeRound.duration = formatDuration(durationMs);
        activeRound.durationMinutes = Math.floor(durationMs / (1000 * 60));

        deliveryHistory.unshift({...activeRound});
        
        const startTimeFormatted = formatDate(activeRound.startTime);
        const endTimeFormatted = formatDate(activeRound.endTime);
        let messageContent = `RIEPILOGO GIRO CONSEGNE\nFattorino: ${activeRound.driverName}\nData e Ora Partenza: ${startTimeFormatted}\nData e Ora Fine: ${endTimeFormatted}\nDurata Totale: ${activeRound.duration}\nClienti serviti:\n`;
        activeRound.customers.forEach(c => messageContent += `- ${c}\n`);
        messageContent = messageContent.trim();

        activeRound = null;
        updateActiveRoundUI();
        renderHistoryList();
        saveAllData();
        updateDailyStats();
        
        const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(messageContent)}`;
        window.open(whatsappUrl, '_blank');
        showInteractiveToast('Giro concluso! WhatsApp si apre...', messageContent);
    });

    // --- CRONOLOGIA (con ricerca e export CSV/PDF) ---
    function renderHistoryList(filterText = '') {
        if (!deliveryHistoryList || !noHistoryMessage || !downloadReportBtn || !downloadCsvReportBtn || !downloadPdfReportBtn) return;
        deliveryHistoryList.innerHTML = '';
        
        const filteredHistory = deliveryHistory.filter(round => {
            if (!filterText) return true;
            const searchText = filterText.toLowerCase();
            const roundDate = round.startTime ? formatDate(round.startTime).toLowerCase() : "";
            return (
                (round.driverName ? round.driverName.toLowerCase().includes(searchText) : false) ||
                (Array.isArray(round.customers) && round.customers.some(c => c.toLowerCase().includes(searchText))) ||
                roundDate.includes(searchText)
            );
        });

        if (filteredHistory.length === 0) {
            noHistoryMessage.classList.remove('hidden');
            downloadReportBtn.classList.add('opacity-50', 'cursor-not-allowed');
            downloadReportBtn.disabled = true;
            downloadCsvReportBtn.classList.add('opacity-50', 'cursor-not-allowed');
            downloadCsvReportBtn.disabled = true;
            downloadPdfReportBtn.classList.add('opacity-50', 'cursor-not-allowed');
            downloadPdfReportBtn.disabled = true;
            if (filterText) {
                 noHistoryMessage.innerHTML = `<i class="fas fa-search fa-3x text-gray-500 mb-3"></i><p class="text-gray-400 text-sm sm:text-base">Nessun risultato per "${filterText}".</p>`;
            } else {
                 noHistoryMessage.innerHTML = `<i class="fas fa-box-open fa-3x text-gray-500 mb-3"></i><p class="text-gray-400 text-sm sm:text-base">Nessuna consegna registrata.</p>`;
            }
            return;
        }
        noHistoryMessage.classList.add('hidden');
        downloadReportBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        downloadReportBtn.disabled = false;
        downloadCsvReportBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        downloadCsvReportBtn.disabled = false;
        downloadPdfReportBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        downloadPdfReportBtn.disabled = false;


        filteredHistory.forEach(round => {
            const div = document.createElement('div');
            div.className = 'p-3 bg-gray-500 rounded shadow text-xs sm:text-sm';
            let customersArray = Array.isArray(round.customers) ? round.customers : [];
            let customersHtml = customersArray.map(c => `<li class="ml-4"><i class="fas fa-user-tag fa-fw mr-1 text-gray-300"></i> <span class="break-all">${c}</span></li>`).join('');
            div.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <p class="font-semibold"><i class="fas fa-calendar-check fa-fw mr-1"></i> ${formatDate(round.startTime)}</p>
                    <p class="text-gray-300">Durata: ${round.duration || 'N/A'}</p>
                </div>
                <p class="mb-1"><i class="fas fa-shipping-fast fa-fw mr-1"></i> Fattorino: <span class="break-all">${round.driverName || 'N/A'}</span></p>
                <p class="font-medium">Clienti (${customersArray.length}):</p>
                <ul class="list-none">${customersHtml}</ul>
            `;
            deliveryHistoryList.appendChild(div);
        });
    }

    if (historySearchInput) historySearchInput.addEventListener('input', (e) => {
        renderHistoryList(e.target.value);
    });
    
    if (downloadReportBtn) downloadReportBtn.addEventListener('click', () => { // JSON
        const filterText = historySearchInput ? historySearchInput.value : '';
        const dataToExport = deliveryHistory.filter(round => {
            if (!filterText) return true;
            const searchText = filterText.toLowerCase();
            const roundDate = round.startTime ? formatDate(round.startTime).toLowerCase() : "";
            return (round.driverName ? round.driverName.toLowerCase().includes(searchText) : false) ||
                   (Array.isArray(round.customers) && round.customers.some(c => c.toLowerCase().includes(searchText))) ||
                   roundDate.includes(searchText);
        });

        if (dataToExport.length === 0) {
            showToast('Nessuna consegna da esportare (controlla il filtro).', 'error');
            return;
        }
        const dataStr = JSON.stringify(dataToExport, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = `report_consegne_${new Date().toISOString().slice(0,10)}.json`;
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        linkElement.remove();
        showToast('Report JSON scaricato.');
    });

    if (downloadCsvReportBtn) downloadCsvReportBtn.addEventListener('click', () => {
        const filterText = historySearchInput ? historySearchInput.value : '';
        const dataToExport = deliveryHistory.filter(round => {
            if (!filterText) return true;
            const searchText = filterText.toLowerCase();
            const roundDate = round.startTime ? formatDate(round.startTime).toLowerCase() : "";
            return (round.driverName ? round.driverName.toLowerCase().includes(searchText) : false) ||
                   (Array.isArray(round.customers) && round.customers.some(c => c.toLowerCase().includes(searchText))) ||
                   roundDate.includes(searchText);
        });

        if (dataToExport.length === 0) {
            showToast('Nessuna consegna da esportare in CSV (controlla il filtro).', 'error');
            return;
        }

        let csvContent = "ID Giro;Fattorino;Ora Inizio;Ora Fine;Durata;Clienti\n";
        dataToExport.forEach(round => {
            let clientiJoinable = [];
            if (Array.isArray(round.customers)) {
                clientiJoinable = round.customers;
            } else if (round.customers) {
                clientiJoinable = [String(round.customers)];
            }
            const clientiPerCsv = clientiJoinable.join(", ");
            
            const roundId = round.id || "";
            const driverName = round.driverName || "";
            const startTimeFormatted = round.startTime ? formatDate(round.startTime) : "N/A";
            const endTimeFormatted = round.endTime ? formatDate(round.endTime) : "N/A";
            const duration = round.duration || "N/A";
            
            csvContent += `${String(roundId)};${String(driverName)};${String(startTimeFormatted)};${String(endTimeFormatted)};${String(duration)};"${String(clientiPerCsv)}"\n`;
        });

        const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
        const exportFileDefaultName = `report_consegne_${new Date().toISOString().slice(0,10)}.csv`;
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        linkElement.remove();
        showToast('Report CSV scaricato.');
    });

    if (downloadPdfReportBtn) downloadPdfReportBtn.addEventListener('click', () => {
        if (!window.jspdf || !window.jspdf.jsPDF || !window.jspdf.default.autoTable) {
             showToast('Libreria PDF (jsPDF o autoTable) non caricata correttamente.', 'error');
             console.error('jsPDF o jsPDF.autoTable non definiti.');
             return;
        }
        const { jsPDF } = window.jspdf; // jsPDF è solitamente su window.jspdf.jsPDF, ma l'UMD potrebbe esporlo diversamente.
                                      // Il bundle UMD di jspdf solitamente espone jsPDF come window.jspdf.jsPDF
                                      // mentre jspdf-autotable aggiunge il plugin autoTable a jsPDF.API (o jsPDF.prototype)
                                      // Per sicurezza, controlliamo se doc.autoTable esiste.

        const filterText = historySearchInput ? historySearchInput.value : '';
        const dataToExport = deliveryHistory.filter(round => {
            if (!filterText) return true;
            const searchText = filterText.toLowerCase();
            const roundDate = round.startTime ? formatDate(round.startTime).toLowerCase() : "";
            return (round.driverName ? round.driverName.toLowerCase().includes(searchText) : false) ||
                   (Array.isArray(round.customers) && round.customers.some(c => c.toLowerCase().includes(searchText))) ||
                   roundDate.includes(searchText);
        });
        
        if (dataToExport.length === 0) {
            showToast('Nessuna consegna da esportare in PDF (controlla il filtro).', 'error');
            return;
        }

        const doc = new jsPDF();
        if (typeof doc.autoTable !== 'function') {
            showToast('Libreria PDF (autoTable) non caricata correttamente.', 'error');
            console.error('doc.autoTable is not a function.');
            return;
        }

        doc.setFontSize(18);
        doc.text("Report Consegne", 14, 22);
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text(`Generato il: ${formatDate(new Date().toISOString())}`, 14, 30);
        if (filterText) {
            doc.text(`Filtro applicato: "${filterText}"`, 14, 36);
        }

        const tableColumn = ["Fattorino", "Ora Inizio", "Durata", "Clienti"];
        const tableRows = [];

        dataToExport.forEach(round => {
            let customersArray = Array.isArray(round.customers) ? round.customers : (round.customers ? [String(round.customers)] : []);
            const roundData = [
                round.driverName || "N/A",
                round.startTime ? formatDate(round.startTime) : "N/A",
                round.duration || "N/A",
                customersArray.join(",\n")
            ];
            tableRows.push(roundData);
        });

        doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: filterText ? 42 : 36,
            headStyles: { fillColor: [74, 74, 74] },
            styles: { fontSize: 8, cellPadding: 2 },
            columnStyles: {
                3: { cellWidth: 'auto' }
            }
        });
        
        const exportFileDefaultName = `report_consegne_${new Date().toISOString().slice(0,10)}.pdf`;
        doc.save(exportFileDefaultName);
        showToast('Report PDF generato.');
    });


    // --- STATISTICHE GIORNALIERE ---
    function updateDailyStats() {
        if (!dailyStatsContent || !noStatsToday || !statsTodayRounds || !statsTodayCustomers || !statsTodayTotalTime || !statsTodayAvgTimePerRound) return;
        const today = new Date().toISOString().slice(0, 10);
        const todayRounds = deliveryHistory.filter(round => round.startTime && round.startTime.startsWith(today) && round.status === 'concluso');
        if (todayRounds.length === 0) {
            dailyStatsContent.classList.add('hidden');
            noStatsToday.classList.remove('hidden');
            return;
        }
        dailyStatsContent.classList.remove('hidden');
        noStatsToday.classList.add('hidden');
        statsTodayRounds.textContent = todayRounds.length;
        const totalCustomersToday = todayRounds.reduce((sum, round) => sum + (Array.isArray(round.customers) ? round.customers.length : 0), 0);
        statsTodayCustomers.textContent = totalCustomersToday;
        const totalTimeMsToday = todayRounds.reduce((sum, round) => {
            if (round.endTime && round.startTime) return sum + (new Date(round.endTime) - new Date(round.startTime));
            return sum;
        }, 0);
        const totalTimeMinutesToday = Math.floor(totalTimeMsToday / (1000 * 60));
        statsTodayTotalTime.textContent = formatDurationForDisplay(totalTimeMinutesToday);
        const avgTimePerRoundMinutes = todayRounds.length > 0 ? Math.round(totalTimeMinutesToday / todayRounds.length) : 0;
        statsTodayAvgTimePerRound.textContent = `${avgTimePerRoundMinutes} min`;
    }

    // --- ADMIN PANEL ---
    if (openAdminModalLink) openAdminModalLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (!adminLoginModal || !adminLoginError || !adminPasswordInput) return;
        adminLoginModal.classList.remove('hidden');
        adminLoginError.classList.add('hidden');
        adminPasswordInput.value = '';
        adminPasswordInput.focus();
    });
    if (cancelAdminLoginBtn) cancelAdminLoginBtn.addEventListener('click', () => {
        if (adminLoginModal) adminLoginModal.classList.add('hidden');
    });
    if (submitAdminLoginBtn) submitAdminLoginBtn.addEventListener('click', () => {
        if (!adminPasswordInput || !adminLoginModal || !adminLoginError) return;
        if (adminPasswordInput.value === ADMIN_PASSWORD) {
            adminLoginModal.classList.add('hidden');
            switchView('admin');
        } else {
            adminLoginError.classList.remove('hidden');
            adminPasswordInput.value = '';
            adminPasswordInput.focus();
        }
    });
    function switchView(view) {
        if (!mainContent || !adminPanel) return;
        if (view === 'admin') {
            mainContent.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            loadAdminData();
            switchAdminTab('overview');
        } else {
            mainContent.classList.remove('hidden');
            adminPanel.classList.add('hidden');
        }
    }
    if (backToMainViewBtn) backToMainViewBtn.addEventListener('click', () => switchView('main'));
    if (adminLogoutBtn) adminLogoutBtn.addEventListener('click', () => switchView('main'));
    
    if (adminTabs) adminTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            switchAdminTab(e.currentTarget.dataset.tab);
        });
    });

    function switchAdminTab(tabName) {
        if (adminTabs) {
            adminTabs.forEach(t => t.classList.toggle('bg-gray-600', t.dataset.tab === tabName));
            adminTabs.forEach(t => t.classList.toggle('text-white', t.dataset.tab === tabName));
        }
        if (adminTabContents) adminTabContents.forEach(content => content.classList.add('hidden'));
        
        const activeTabContent = document.getElementById(`admin${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`);
        if (activeTabContent) activeTabContent.classList.remove('hidden');
        
        if (tabName === 'overview') loadAdminOverviewData();
        if (tabName === 'drivers') loadAdminDriverPerformanceData();
    }
    function loadAdminData() {
        if (!adminDriverFilter) return;
        const uniqueDrivers = [...new Set(deliveryHistory.map(r => r.driverName))].filter(Boolean);
        adminDriverFilter.innerHTML = '<option value="">Tutti i fattorini</option>';
        uniqueDrivers.forEach(driver => {
            const option = document.createElement('option');
            option.value = driver;
            option.textContent = driver;
            adminDriverFilter.appendChild(option);
        });
        if (adminDateFilter) adminDateFilter.value = '';
        loadAdminOverviewData();
    }
    if (applyAdminFiltersBtn) applyAdminFiltersBtn.addEventListener('click', loadAdminOverviewData);
    
    function loadAdminOverviewData() {
        if (!adminDateFilter || !adminDriverFilter || !adminNoStats || !adminTotalRounds || !adminTotalCustomers ||
            !adminTotalDeliveryTime || !adminActiveDeliveryInfo || !adminRecentDeliveriesList || !adminNoRecentDeliveries) return;

        const selectedDate = adminDateFilter.value;
        const selectedDriver = adminDriverFilter.value;
        let filteredHistory = deliveryHistory.filter(r => r.status === 'concluso');
        if (selectedDate) filteredHistory = filteredHistory.filter(r => r.startTime && r.startTime.startsWith(selectedDate));
        if (selectedDriver) filteredHistory = filteredHistory.filter(r => r.driverName === selectedDriver);
        
        adminNoStats.classList.toggle('hidden', filteredHistory.length > 0);
        adminTotalRounds.textContent = filteredHistory.length;
        adminTotalCustomers.textContent = filteredHistory.reduce((sum, r) => sum + (Array.isArray(r.customers) ? r.customers.length : 0), 0);
        adminTotalDeliveryTime.textContent = formatDurationForDisplay(filteredHistory.reduce((sum, r) => sum + (r.durationMinutes || 0), 0));

        if (activeRound) {
            adminActiveDeliveryInfo.innerHTML = `<p>Fattorino: <span class="font-semibold break-all">${activeRound.driverName}</span></p><p>Iniziato il: <span class="font-semibold">${formatDate(activeRound.startTime)}</span></p><p>Clienti: <span class="font-semibold break-all">${(Array.isArray(activeRound.customers) ? activeRound.customers.join(', ') : '')}</span></p>`;
        } else {
            adminActiveDeliveryInfo.textContent = 'Nessuna consegna attualmente in corso.';
        }
        adminRecentDeliveriesList.innerHTML = '';
        const recentDeliveries = deliveryHistory.slice(0, 5);
        adminNoRecentDeliveries.classList.toggle('hidden', recentDeliveries.length > 0);
        recentDeliveries.forEach(r => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="font-semibold">${formatDate(r.startTime)}</span> - <span class="break-all">${r.driverName || 'N/A'}</span> (${(Array.isArray(r.customers) ? r.customers.length : 0)} clienti) - Durata: ${r.duration || 'N/A'}`;
            adminRecentDeliveriesList.appendChild(li);
        });
    }
    function loadAdminDriverPerformanceData() {
        if (!adminDriverPerformanceList || !adminNoDriverData) return;
        adminDriverPerformanceList.innerHTML = '';
        const drivers = {};
        deliveryHistory.filter(r => r.status === 'concluso' && r.driverName).forEach(round => {
            if (!drivers[round.driverName]) drivers[round.driverName] = { rounds: 0, customers: 0, totalTimeMins: 0 };
            drivers[round.driverName].rounds++;
            drivers[round.driverName].customers += (Array.isArray(round.customers) ? round.customers.length : 0);
            drivers[round.driverName].totalTimeMins += (round.durationMinutes || 0);
        });
        adminNoDriverData.classList.toggle('hidden', Object.keys(drivers).length > 0);
        for (const driverName in drivers) {
            const data = drivers[driverName];
            const avgTimePerRound = data.rounds > 0 ? Math.round(data.totalTimeMins / data.rounds) : 0;
            const avgCustomersPerRound = data.rounds > 0 ? (data.customers / data.rounds).toFixed(1) : 0;
            const div = document.createElement('div');
            div.className = 'p-3 bg-gray-600 rounded text-xs sm:text-sm';
            div.innerHTML = `<h4 class="font-semibold text-sm sm:text-base break-all">${driverName}</h4><ul class="list-disc list-inside space-y-0.5 mt-1"><li>Giri completati: ${data.rounds}</li><li>Clienti totali serviti: ${data.customers}</li><li>Tempo totale in consegna: ${formatDurationForDisplay(data.totalTimeMins)}</li><li>Tempo medio per giro: ${avgTimePerRound} min</li><li>Clienti medi per giro: ${avgCustomersPerRound}</li></ul>`;
            adminDriverPerformanceList.appendChild(div);
        }
    }

    // --- INIZIALIZZAZIONE (precedentemente in un altro DOMContentLoaded) ---
    try {
        loadAllData();
        if (customers.length === 0 && !activeRound) {
            customers = ["", ""];
            renderCustomerInputs();
        }
    } catch (e) {
        console.error("Errore critico durante l'inizializzazione:", e);
        const body = document.querySelector('body');
        if (body) {
            const errorDiv = document.createElement('div');
            errorDiv.style.color = 'red';
            errorDiv.style.backgroundColor = 'black';
            errorDiv.style.padding = '20px';
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '0';
            errorDiv.style.left = '0';
            errorDiv.style.width = '100%';
            errorDiv.style.zIndex = '9999';
            errorDiv.textContent = 'ERRORE CRITICO: Impossibile inizializzare l\'applicazione. Controllare la console per dettagli.';
            body.prepend(errorDiv);
        }
    }
}); // FINE DEL DOMContentLoaded PRINCIPALE
</script>
</body>
</html>