<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.R. AUTO - Delivery Manager</title>
    <style>
        /* Font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        /* Stili Generali e Dark Mode */
        :root {
            --bg-main: #2D2D2D;
            --bg-card: #4A4A4A;
            --bg-input: #3D3D3D;
            --text-primary: #F3F4F6; /* Grigio molto chiaro */
            --text-secondary: #9CA3AF;
            --border-color: #555555;
            --green-primary: #28a745;
            --red-danger: #dc3545;
            --blue-gemini: #4285F4; /* Colore per funzionalità Gemini */
            --gray-secondary-btn: #555555;
            --gray-light-btn: #6B7280; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            margin: 0;
            padding: 1rem;
            font-size: 16px;
            line-height: 1.5;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px; 
            padding: 0 10px;
            box-sizing: border-box;
        }

        /* Header */
        .app-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .app-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0.5rem 0 0.25rem;
            color: var(--text-primary);
        }
        .app-header .subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        /* Card */
        .card {
            background-color: var(--bg-card);
            border-radius: 0.75rem; 
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            color: var(--text-primary);
        }
        .card-title svg {
            width: 1.5rem; 
            height: 1.5rem; 
            margin-right: 0.5rem;
            stroke-width: 1.5;
        }

        /* Input Fields */
        .input-group {
            margin-bottom: 1rem;
            position: relative;
        }
        .input-field {
            width: 100%;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem; 
            font-size: 1rem;
            box-sizing: border-box;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--green-primary);
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
        }
        .input-field::placeholder {
            color: var(--text-secondary);
        }

        /* Pulsanti */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; 
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
            width: 100%; 
            box-sizing: border-box;
            text-align: center;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn svg, .btn .emoji-icon { 
            width: 1.25rem; 
            height: 1.25rem; 
            margin-right: 0.5rem;
            display: inline-block; 
        }

        .btn-primary { background-color: var(--green-primary); }
        .btn-primary:hover { background-color: #218838; }

        .btn-secondary { background-color: var(--gray-secondary-btn); }
        .btn-secondary:hover { background-color: #444444; }
        
        .btn-danger { background-color: var(--red-danger); }
        .btn-danger:hover { background-color: #c82333; }

        .btn-light { background-color: var(--gray-light-btn); color: var(--text-primary); }
        .btn-light:hover { background-color: #5a6268; }

        .btn-gemini { background-color: var(--blue-gemini); }
        .btn-gemini:hover { background-color: #3367D6; }


        /* Sezione Inserimento Clienti */
        .client-input-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .client-input-item .input-field {
            flex-grow: 1;
            margin-right: 0.5rem;
        }
        .btn-remove-client {
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-remove-client:hover {
            background-color: var(--bg-input);
            color: var(--text-primary);
        }
        .btn-remove-client svg {
            width: 1.125rem; 
            height: 1.125rem; 
        }

        /* Sezione Giro Attivo */
        #sezioneGiroAttivo .cronometro-display {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin: 0.5rem 0 1.5rem;
            color: var(--green-primary);
        }
        #sezioneGiroAttivo .dettaglio-giro p {
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        #sezioneGiroAttivo .dettaglio-giro strong {
            color: var(--text-secondary);
        }
        #clientiDaServireLista {
            list-style-type: none;
            padding-left: 0;
            max-height: 200px; /* Aumentata altezza per più clienti */
            overflow-y: auto;
            background-color: var(--bg-input);
            border-radius: 0.375rem;
            padding: 0.75rem;
        }
        #clientiDaServireLista li {
            padding: 0.5rem 0.25rem; /* Aggiunto padding laterale */
            border-bottom: 1px solid var(--border-color);
            display: flex; /* Per allineare checkbox e label */
            align-items: center;
        }
        #clientiDaServireLista li:last-child {
            border-bottom: none;
        }
        #clientiDaServireLista input[type="checkbox"] {
            margin-right: 0.75rem;
            min-width: 18px; /* Dimensione minima checkbox */
            min-height: 18px;
            accent-color: var(--green-primary); /* Colore spunta */
        }
        #clientiDaServireLista label {
            flex-grow: 1;
        }
        #clientiDaServireLista .cliente-consegnato-label span.nome-cliente {
            text-decoration: line-through;
            color: var(--text-secondary);
        }
        #clientiDaServireLista .orario-consegna {
            font-size: 0.8em;
            color: var(--green-primary);
            margin-left: 0.5em;
        }


        /* Notifiche Toast */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-card);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            font-size: 0.9rem;
        }
        .toast-notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast-notification.success {
            background-color: var(--green-primary);
            color: white;
        }
        .toast-notification.error {
            background-color: var(--red-danger);
            color: white;
        }
        .toast-notification.info {
            background-color: var(--blue-gemini);
            color: white;
        }

        /* Cronologia */
        #cronologiaGiriLista {
            list-style-type: none;
            padding-left: 0;
        }
        #cronologiaGiriLista li.history-item { 
            background-color: var(--bg-input);
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        #cronologiaGiriLista li.history-item p {
            margin: 0.25rem 0;
        }
        #cronologiaGiriLista li.history-item svg { 
            width: 0.875rem; 
            height: 0.875rem; 
            margin-right: 0.25rem; 
            vertical-align: middle;
        }
        .clienti-count-clickable {
            cursor: pointer;
            color: var(--green-primary); 
            text-decoration: underline;
            font-weight: bold; 
        }
        .clienti-count-clickable:hover {
            color: #34c759; 
        }
        .history-item-client-list {
            list-style-type: disc;
            margin-left: 20px; 
            margin-top: 0.5rem;
            background-color: #333333; 
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        .history-item-client-list li {
            color: var(--text-primary);
            padding: 0.125rem 0;
            font-size: 0.85rem; 
            background-color: transparent;
            border-bottom: none;
            margin-bottom: 0;
            /* Reset per evitare conflitti con stili #clientiDaServireLista li */
            display: list-item; 
            align-items: normal;
        }
        .history-item-client-list .cliente-consegnato {
            color: var(--green-primary);
        }
        .history-item-client-list .cliente-non-consegnato {
            color: var(--text-secondary);
        }


        /* Loading Spinner */
        .loader {
            border: 4px solid var(--bg-input);
            border-left-color: var(--green-primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0.5rem auto; 
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Custom Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--bg-card);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        .modal-content p {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
        }
        .modal-buttons {
            display: flex;
            justify-content: space-around;
        }
        .modal-buttons .btn {
            width: 45%; 
        }

        /* Utility */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .w-full { width: 100%; }

    </style>
</head>
<body>
    <div class="container">
        <header class="app-header">
            <h1>A.R. AUTO - Delivery Manager</h1>
            <p class="subtitle">Prodotto da Federico Battistella</p>
        </header>

        <section id="sezioneSetupFattorino" class="card">
            <h2 class="card-title">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                Fattorino
            </h2>
            <div class="input-group">
                <input type="text" id="nomeFattorinoInput" class="input-field" placeholder="Inserisci il tuo nome">
                <p id="displayNomeFattorino" class="mt-2 hidden" style="font-size: 1.1rem;"></p>
            </div>
            <button id="btnSalvaNome" class="btn btn-primary">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>
                Salva Nome
            </button>
            <button id="btnModificaNome" class="btn btn-secondary mt-2 hidden">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                Modifica Nome
            </button>
        </section>

        <section id="sezioneInserimentoClienti" class="card">
            <h2 class="card-title">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 016-6h6M21 21h-1a6 6 0 00-6-6h-1m11-4a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                Clienti del Giro
            </h2>
            <div id="listaInputClienti">
                </div>
            <button id="btnAggiungiCliente" class="btn btn-secondary mt-3">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                Aggiungi Cliente
            </button>
             <button id="btnOttimizzaPercorso" class="btn btn-gemini mt-2">
                <span class="emoji-icon">✨</span>
                Ottimizza Percorso
            </button>
            <div id="loaderOttimizzazione" class="loader hidden mt-2"></div>
            <button id="btnResetListaClienti" class="btn btn-light mt-2">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                Reset Lista Clienti
            </button>
        </section>

        <section id="sezioneAzionePrincipale" class="mt-4 mb-4">
            <button id="btnAzionePrincipale" class="btn btn-primary btn-lg w-full">
            </button>
        </section>

        <section id="sezioneGiroAttivo" class="card hidden">
            <h2 class="card-title">
                 <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Giro Attivo
            </h2>
            <p class="text-center">Tempo Trascorso:</p>
            <div id="cronometroDisplay" class="cronometro-display">00:00:00</div>
            <div class="dettaglio-giro">
                <p><strong>Fattorino:</strong> <span id="giroAttivoFattorino">N/D</span></p>
                <p><strong>Ora Partenza:</strong> <span id="giroAttivoOraPartenza">N/D</span></p>
                <p><strong>Clienti da servire:</strong></p>
                <ul id="clientiDaServireLista">
                </ul>
            </div>
        </section>

        <section id="sezioneCronologia" class="card">
            <h2 class="card-title">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v1.586M12 12.253v1.586M12 18.253v1.586M7.5 12.253h1.586M13.5 12.253h1.586M16.732 3.732a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                Ultimi Giri
            </h2>
            <ul id="cronologiaGiriLista">
            </ul>
            <button id="btnCancellaCronologia" class="btn btn-light mt-3">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                Cancella Cronologia
            </button>
        </section>

        <div id="toastNotification" class="toast-notification">Messaggio Toast</div>

        <div id="customModal" class="modal-overlay">
            <div class="modal-content">
                <h3 id="modalTitle">Conferma Azione</h3>
                <p id="modalMessage">Sei sicuro di voler procedere?</p>
                <div class="modal-buttons">
                    <button id="modalConfirmBtn" class="btn btn-danger">Conferma</button>
                    <button id="modalCancelBtn" class="btn btn-secondary">Annulla</button>
                </div>
            </div>
        </div>

    </div> 
    <script>
        // Elementi DOM
        const nomeFattorinoInput = document.getElementById('nomeFattorinoInput');
        const displayNomeFattorino = document.getElementById('displayNomeFattorino');
        const btnSalvaNome = document.getElementById('btnSalvaNome');
        const btnModificaNome = document.getElementById('btnModificaNome');
        
        const listaInputClienti = document.getElementById('listaInputClienti');
        const btnAggiungiCliente = document.getElementById('btnAggiungiCliente');
        const btnResetListaClienti = document.getElementById('btnResetListaClienti');
        const btnOttimizzaPercorso = document.getElementById('btnOttimizzaPercorso');
        const loaderOttimizzazione = document.getElementById('loaderOttimizzazione');
        
        const btnAzionePrincipale = document.getElementById('btnAzionePrincipale');
        
        const sezioneGiroAttivo = document.getElementById('sezioneGiroAttivo');
        const cronometroDisplay = document.getElementById('cronometroDisplay');
        const giroAttivoFattorino = document.getElementById('giroAttivoFattorino');
        const giroAttivoOraPartenza = document.getElementById('giroAttivoOraPartenza');
        const clientiDaServireLista = document.getElementById('clientiDaServireLista');

        const cronologiaGiriLista = document.getElementById('cronologiaGiriLista');
        const btnCancellaCronologia = document.getElementById('btnCancellaCronologia');

        const toastNotification = document.getElementById('toastNotification');

        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        let modalConfirmCallback = null;


        const WHATSAPP_NUMBER = '393939393799'; 
        const GEMINI_API_KEY = ''; 

        let cronometroInterval;
        let clientInputCount = 0;

        const playIconSVG = `<svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>`;
        const stopIconSVG = `<svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"></path></svg>`;

        function mostraNotifica(messaggio, tipo = 'successo') { 
            toastNotification.textContent = messaggio;
            toastNotification.className = 'toast-notification show';
            if (tipo === 'successo') {
                toastNotification.classList.add('success');
            } else if (tipo === 'errore') {
                toastNotification.classList.add('error');
            } else if (tipo === 'info') {
                toastNotification.classList.add('info');
            }
            setTimeout(() => {
                toastNotification.className = 'toast-notification';
            }, 3000);
        }

        function formatTimeHHMMSS(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function formatDurationForMessage(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            let parts = [];
            if (hours > 0) parts.push(`${hours} ore`);
            if (minutes > 0) parts.push(`${minutes} minuti`);
            if (seconds > 0 || (hours === 0 && minutes === 0)) parts.push(`${seconds} secondi`);
            return parts.join(' ');
        }
        
        function formatDateTimeForMessage(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('it-IT', { 
                day: '2-digit', month: '2-digit', year: 'numeric', 
                hour: '2-digit', minute: '2-digit' 
            });
        }
         function formatTimeOnlyForDisplay(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('it-IT', {
                hour: '2-digit', minute: '2-digit'
            });
        }


        function showModal(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirmCallback = onConfirm;
            customModal.classList.add('show');
        }

        function hideModal() {
            customModal.classList.remove('show');
            modalConfirmCallback = null;
        }

        modalConfirmBtn.addEventListener('click', () => {
            if (modalConfirmCallback) {
                modalConfirmCallback();
            }
            hideModal();
        });

        modalCancelBtn.addEventListener('click', hideModal);
        customModal.addEventListener('click', (event) => { 
            if (event.target === customModal) {
                hideModal();
            }
        });

        function caricaNomeFattorino() {
            const nomeSalvato = localStorage.getItem('nomeFattorino');
            if (nomeSalvato) {
                nomeFattorinoInput.value = nomeSalvato;
                nomeFattorinoInput.classList.add('hidden');
                displayNomeFattorino.textContent = `Fattorino: ${nomeSalvato}`;
                displayNomeFattorino.classList.remove('hidden');
                btnSalvaNome.classList.add('hidden');
                btnModificaNome.classList.remove('hidden');
            } else {
                nomeFattorinoInput.classList.remove('hidden');
                displayNomeFattorino.classList.add('hidden');
                btnSalvaNome.classList.remove('hidden');
                btnModificaNome.classList.add('hidden');
            }
        }

        btnSalvaNome.addEventListener('click', () => {
            const nome = nomeFattorinoInput.value.trim();
            if (nome) {
                localStorage.setItem('nomeFattorino', nome);
                caricaNomeFattorino();
                mostraNotifica('Nome fattorino salvato!');
            } else {
                mostraNotifica('Inserisci un nome per il fattorino', 'errore');
            }
        });

        btnModificaNome.addEventListener('click', () => {
            nomeFattorinoInput.classList.remove('hidden');
            displayNomeFattorino.classList.add('hidden');
            btnSalvaNome.classList.remove('hidden');
            btnModificaNome.classList.add('hidden');
            nomeFattorinoInput.focus();
        });

        function aggiungiCampoCliente(nomeCliente = '', placeholderText = `Cliente ${clientInputCount + 1}`) {
            clientInputCount++; 
            const div = document.createElement('div');
            div.classList.add('client-input-item');
            div.innerHTML = `
                <input type="text" class="input-field" placeholder="${placeholderText}" value="${nomeCliente}">
                <button type="button" class="btn-remove-client" title="Rimuovi cliente">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;
            listaInputClienti.appendChild(div);
            div.querySelector('.btn-remove-client').addEventListener('click', () => {
                div.remove();
            });
        }
        
        function aggiornaCampiCliente(clientiOrdinati) {
            listaInputClienti.innerHTML = ''; 
            clientInputCount = 0; 
            clientiOrdinati.forEach((cliente, index) => {
                // Se cliente è una stringa (da ottimizzazione), o un oggetto (da caricamento giro esistente)
                const nome = typeof cliente === 'string' ? cliente : cliente.nome;
                aggiungiCampoCliente(nome, `Cliente ${index + 1} (ottimizzato)`);
            });
            if (clientiOrdinati.length === 0) {
                 aggiungiCampoCliente();
            }
        }


        btnAggiungiCliente.addEventListener('click', () => aggiungiCampoCliente());

        btnResetListaClienti.addEventListener('click', () => {
            listaInputClienti.innerHTML = '';
            clientInputCount = 0;
            aggiungiCampoCliente(); 
            mostraNotifica('Lista clienti resettata.');
        });

        function getClientiInseriti() {
            const inputs = listaInputClienti.querySelectorAll('.input-field');
            const clienti = [];
            inputs.forEach(input => {
                const nome = input.value.trim();
                if (nome) clienti.push(nome);
            });
            return clienti;
        }
        
        async function chiamaGeminiPerOttimizzazione(clienti) {
            loaderOttimizzazione.classList.remove('hidden');
            btnOttimizzaPercorso.disabled = true;

            const prompt = `Ho la seguente lista di clienti da visitare per delle consegne: ${clienti.join(', ')}. Suggerisci un ordine ottimizzato per visitarli. Restituisci la lista riordinata dei nomi dei clienti come un oggetto JSON con una chiave 'clienti_ottimizzati' che contiene un array di stringhe. Ad esempio: {"clienti_ottimizzati": ["Cliente C", "Cliente A", "Cliente B"]}.`;

            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "clienti_ottimizzati": {
                                type: "ARRAY",
                                items: { type: "STRING" }
                            }
                        },
                        required: ["clienti_ottimizzati"]
                    }
                }
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`Errore API Gemini: ${response.status} ${response.statusText}. Dettagli: ${errorBody}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    const textResponse = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(textResponse); 
                    
                    if (parsedJson && parsedJson.clienti_ottimizzati) {
                        return parsedJson.clienti_ottimizzati;
                    } else {
                        throw new Error("Risposta da Gemini non valida o mancante di 'clienti_ottimizzati'.");
                    }
                } else {
                    console.error("Struttura risposta Gemini inattesa:", result);
                    throw new Error('Risposta da Gemini non valida o struttura inattesa.');
                }
            } catch (error) {
                console.error('Errore durante la chiamata a Gemini:', error);
                mostraNotifica(`Errore ottimizzazione: ${error.message}`, 'errore');
                return null; 
            } finally {
                loaderOttimizzazione.classList.add('hidden');
                btnOttimizzaPercorso.disabled = false;
            }
        }

        btnOttimizzaPercorso.addEventListener('click', async () => {
            const clientiAttuali = getClientiInseriti();
            if (clientiAttuali.length < 2) {
                mostraNotifica('Inserisci almeno due clienti per l\'ottimizzazione.', 'info');
                return;
            }
            
            mostraNotifica('Ottimizzazione percorso in corso...', 'info');
            const clientiOttimizzati = await chiamaGeminiPerOttimizzazione(clientiAttuali);

            if (clientiOttimizzati) {
                aggiornaCampiCliente(clientiOttimizzati);
                mostraNotifica('Percorso ottimizzato da Gemini! Controlla la nuova lista.', 'successo');
            }
        });

        function avviaCronometro(startTime) {
            const giroStartTime = parseInt(startTime);
            if (isNaN(giroStartTime)) return;

            function aggiorna() {
                const now = Date.now();
                const elapsedSeconds = Math.floor((now - giroStartTime) / 1000);
                cronometroDisplay.textContent = formatTimeHHMMSS(elapsedSeconds);
            }
            aggiorna(); 
            cronometroInterval = setInterval(aggiorna, 1000);
        }

        function fermaCronometro() {
            clearInterval(cronometroInterval);
            cronometroDisplay.textContent = '00:00:00';
        }

        function aggiornaUIGiroInCorso() {
            const nomeFattorino = localStorage.getItem('nomeFattorino');
            const oraPartenza = localStorage.getItem('giroOraPartenza');
            // Ora 'giroClienti' è un array di oggetti
            const clientiDataJSON = localStorage.getItem('giroClienti');
            const clientiData = clientiDataJSON ? JSON.parse(clientiDataJSON) : [];

            giroAttivoFattorino.textContent = nomeFattorino || 'N/D';
            giroAttivoOraPartenza.textContent = oraPartenza || 'N/D';
            
            clientiDaServireLista.innerHTML = ''; // Pulisce la lista precedente
            if (clientiData.length > 0) {
                clientiData.forEach((cliente, index) => {
                    const li = document.createElement('li');
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `cliente-consegna-${index}`;
                    checkbox.checked = cliente.consegnato;
                    checkbox.disabled = cliente.consegnato; // Disabilita se già consegnato
                    checkbox.dataset.clienteIndex = index;

                    const label = document.createElement('label');
                    label.htmlFor = `cliente-consegna-${index}`;
                    
                    const nomeClienteSpan = document.createElement('span');
                    nomeClienteSpan.classList.add('nome-cliente');
                    nomeClienteSpan.textContent = cliente.nome;
                    label.appendChild(nomeClienteSpan);

                    if (cliente.consegnato) {
                        label.classList.add('cliente-consegnato-label');
                        const orarioSpan = document.createElement('span');
                        orarioSpan.classList.add('orario-consegna');
                        orarioSpan.textContent = `(${cliente.oraConsegnaFormattata})`;
                        label.appendChild(orarioSpan);
                    }
                    
                    checkbox.addEventListener('change', (event) => {
                        const idx = parseInt(event.target.dataset.clienteIndex);
                        const clientiAttuali = JSON.parse(localStorage.getItem('giroClienti') || '[]');
                        
                        if (event.target.checked && !clientiAttuali[idx].consegnato) {
                            const now = Date.now();
                            clientiAttuali[idx].consegnato = true;
                            clientiAttuali[idx].timestampConsegna = now;
                            clientiAttuali[idx].oraConsegnaFormattata = formatTimeOnlyForDisplay(now);
                            
                            localStorage.setItem('giroClienti', JSON.stringify(clientiAttuali));
                            mostraNotifica(`Consegna a ${clientiAttuali[idx].nome} registrata alle ${clientiAttuali[idx].oraConsegnaFormattata}!`);
                            aggiornaUIGiroInCorso(); // Ricarica la lista per aggiornare lo stato (checkbox disabilitata, testo)
                        }
                    });

                    li.appendChild(checkbox);
                    li.appendChild(label);
                    clientiDaServireLista.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'Nessun cliente specificato.';
                clientiDaServireLista.appendChild(li);
            }
            
            document.getElementById('sezioneSetupFattorino').classList.add('hidden');
            document.getElementById('sezioneInserimentoClienti').classList.add('hidden');
            sezioneGiroAttivo.classList.remove('hidden');
            btnAzionePrincipale.innerHTML = `${stopIconSVG} Giro Concluso`;
            btnAzionePrincipale.classList.remove('btn-primary');
            btnAzionePrincipale.classList.add('btn-danger');

            const giroStartTime = localStorage.getItem('giroStartTime');
            if (giroStartTime) {
                avviaCronometro(giroStartTime);
            }
        }

        function aggiornaUINessunGiro() {
            document.getElementById('sezioneSetupFattorino').classList.remove('hidden');
            document.getElementById('sezioneInserimentoClienti').classList.remove('hidden');
            sezioneGiroAttivo.classList.add('hidden');
            btnAzionePrincipale.innerHTML = `${playIconSVG} Inizia Giro`;
            btnAzionePrincipale.classList.remove('btn-danger');
            btnAzionePrincipale.classList.add('btn-primary');
            
            listaInputClienti.innerHTML = '';
            clientInputCount = 0;
            aggiungiCampoCliente();

            fermaCronometro();
        }

        btnAzionePrincipale.addEventListener('click', () => {
            const giroAttivo = localStorage.getItem('giroAttivo') === 'true';

            if (giroAttivo) {
                // Concludi Giro
                const giroStartTime = parseFloat(localStorage.getItem('giroStartTime'));
                const endTime = Date.now();
                const durataTotaleMs = endTime - giroStartTime;
                const durataTotaleSec = Math.floor(durataTotaleMs / 1000);
                const durataFormattataMsg = formatDurationForMessage(durataTotaleSec);
                const oraFineFormattata = formatDateTimeForMessage(endTime);

                const nomeFattorino = localStorage.getItem('giroFattorino');
                const oraPartenza = localStorage.getItem('giroOraPartenza');
                // Recupera i dati dei clienti con lo stato di consegna
                const clientiData = JSON.parse(localStorage.getItem('giroClienti') || '[]');

                let messaggio = `RIEPILOGO GIRO CONSEGNE\n`;
                messaggio += `Fattorino: ${nomeFattorino}\n`;
                messaggio += `Data e Ora Partenza: ${oraPartenza}\n`;
                messaggio += `Data e Ora Fine: ${oraFineFormattata}\n`;
                messaggio += `Durata Totale: ${durataFormattataMsg}\n`;
                messaggio += `Clienti serviti:\n`;
                clientiData.forEach(c => {
                    messaggio += `- ${c.nome}`;
                    if (c.consegnato) {
                        messaggio += ` (Consegnato: ${c.oraConsegnaFormattata})`;
                    } else {
                        messaggio += ` (Non consegnato)`;
                    }
                    messaggio += `\n`;
                });

                window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(messaggio)}`, '_blank');

                const giroConcluso = {
                    id: Date.now(), 
                    data: new Date(giroStartTime).toLocaleDateString('it-IT'),
                    nomeFattorino,
                    oraPartenza,
                    oraFine: oraFineFormattata,
                    durata: durataFormattataMsg,
                    clientiList: clientiData, // Salva l'array di oggetti dettagliato
                    // clientiCount è il totale, clientiServitiCount è quanti effettivamente consegnati
                    clientiCount: clientiData.length, 
                    clientiServitiCount: clientiData.filter(c => c.consegnato).length 
                };
                salvaInCronologia(giroConcluso);

                localStorage.removeItem('giroAttivo');
                localStorage.removeItem('giroStartTime');
                localStorage.removeItem('giroOraPartenza');
                localStorage.removeItem('giroFattorino');
                localStorage.removeItem('giroClienti'); // Rimuove i dati dettagliati del giro attivo

                aggiornaUINessunGiro();
                mostraNotifica('Giro concluso con successo!');
                caricaCronologia();

            } else {
                // Inizia Giro
                const nomeFattorino = localStorage.getItem('nomeFattorino');
                if (!nomeFattorino) {
                    mostraNotifica('Salva prima il nome del fattorino', 'errore');
                    return;
                }

                const clientiNomi = getClientiInseriti();
                if (clientiNomi.length === 0) {
                    mostraNotifica('Inserisci almeno un cliente', 'errore');
                    return;
                }
                // Trasforma i nomi dei clienti in oggetti con stato di consegna
                const clientiData = clientiNomi.map(nome => ({ 
                    nome: nome, 
                    consegnato: false, 
                    oraConsegnaFormattata: null,
                    timestampConsegna: null 
                }));


                const startTime = Date.now();
                const oraPartenzaFormattata = formatDateTimeForMessage(startTime);

                localStorage.setItem('giroAttivo', 'true');
                localStorage.setItem('giroStartTime', startTime.toString());
                localStorage.setItem('giroOraPartenza', oraPartenzaFormattata);
                localStorage.setItem('giroFattorino', nomeFattorino);
                localStorage.setItem('giroClienti', JSON.stringify(clientiData)); // Salva i dati dettagliati

                let messaggio = `INIZIO GIRO CONSEGNE\n`;
                messaggio += `Fattorino: ${nomeFattorino}\n`;
                messaggio += `Data e Ora Partenza: ${oraPartenzaFormattata}\n`;
                messaggio += `Clienti da servire:\n`;
                clientiData.forEach(c => messaggio += `- ${c.nome}\n`); // Messaggio iniziale mostra solo i nomi
                
                window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(messaggio)}`, '_blank');
                
                aggiornaUIGiroInCorso();
                mostraNotifica('Giro consegne iniziato!');
            }
        });

        const MAX_CRONOLOGIA_ITEMS = 5;
        function getCronologia() {
            const cronologiaJSON = localStorage.getItem('cronologiaGiri');
            return cronologiaJSON ? JSON.parse(cronologiaJSON) : [];
        }

        function salvaInCronologia(giroConcluso) {
            let cronologia = getCronologia();
            cronologia.unshift(giroConcluso); 
            if (cronologia.length > MAX_CRONOLOGIA_ITEMS) {
                cronologia = cronologia.slice(0, MAX_CRONOLOGIA_ITEMS);
            }
            localStorage.setItem('cronologiaGiri', JSON.stringify(cronologia));
        }
        
        const calendarIconSVG = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`;
        const clockIconSVG = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
        const usersIconSVG = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 016-6h6M21 21h-1a6 6 0 00-6-6h-1m11-4a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;

        function caricaCronologia() {
            const cronologia = getCronologia();
            cronologiaGiriLista.innerHTML = '';
            if (cronologia.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'Nessun giro nella cronologia.';
                li.style.textAlign = 'center';
                li.style.color = 'var(--text-secondary)';
                cronologiaGiriLista.appendChild(li);
                btnCancellaCronologia.classList.add('hidden');
                return;
            }
            
            btnCancellaCronologia.classList.remove('hidden');
            cronologia.forEach(giro => {
                const li = document.createElement('li');
                li.classList.add('history-item'); 
                li.dataset.giroId = giro.id;

                const summaryDiv = document.createElement('div');
                summaryDiv.classList.add('history-item-summary');
                const clientiServitiCount = giro.clientiList.filter(c => c.consegnato).length;
                const totalClienti = giro.clientiList.length;

                summaryDiv.innerHTML = `
                    <p><strong>Fattorino:</strong> ${giro.nomeFattorino}</p>
                    <p>${calendarIconSVG} <strong>Data:</strong> ${giro.data} (${formatTimeOnlyForDisplay(new Date(giro.oraPartenza.split(', ')[0].split('/').reverse().join('-') + 'T' + giro.oraPartenza.split(', ')[1]))} - ${formatTimeOnlyForDisplay(new Date(giro.oraFine.split(', ')[0].split('/').reverse().join('-') + 'T' + giro.oraFine.split(', ')[1]))})</p>
                    <p>${clockIconSVG} <strong>Durata:</strong> ${giro.durata}</p>
                    <p class="clienti-count-clickable" title="Clicca per vedere i clienti">
                        ${usersIconSVG} <strong>Clienti:</strong> ${clientiServitiCount} / ${totalClienti} serviti (dettagli)
                    </p>
                `;
                
                const clientListUl = document.createElement('ul');
                clientListUl.classList.add('history-item-client-list', 'hidden');
                
                li.appendChild(summaryDiv);
                li.appendChild(clientListUl);
                
                const clientiCountElement = summaryDiv.querySelector('.clienti-count-clickable');
                clientiCountElement.addEventListener('click', (event) => {
                    event.stopPropagation(); 
                    const isHidden = clientListUl.classList.contains('hidden');
                    if (isHidden) {
                        clientListUl.innerHTML = ''; 
                        if (giro.clientiList && giro.clientiList.length > 0) {
                            giro.clientiList.forEach(cliente => {
                                const clienteLi = document.createElement('li');
                                let testoCliente = cliente.nome;
                                if (cliente.consegnato) {
                                    clienteLi.classList.add('cliente-consegnato');
                                    testoCliente += ` (Consegnato: ${cliente.oraConsegnaFormattata})`;
                                } else {
                                    clienteLi.classList.add('cliente-non-consegnato');
                                    testoCliente += ` (Non consegnato)`;
                                }
                                clienteLi.textContent = testoCliente;
                                clientListUl.appendChild(clienteLi);
                            });
                        } else {
                            const noClienteLi = document.createElement('li');
                            noClienteLi.textContent = 'Nessun cliente registrato per questo giro.';
                            clientListUl.appendChild(noClienteLi);
                        }
                        clientListUl.classList.remove('hidden');
                    } else {
                        clientListUl.classList.add('hidden');
                    }
                });
                cronologiaGiriLista.appendChild(li);
            });
        }

        btnCancellaCronologia.addEventListener('click', () => {
            showModal(
                'Conferma Cancellazione', 
                'Sei sicuro di voler cancellare tutta la cronologia? L\'azione è irreversibile.',
                () => { 
                    localStorage.removeItem('cronologiaGiri');
                    caricaCronologia();
                    mostraNotifica('Cronologia cancellata.');
                }
            );
        });

        function initApp() {
            caricaNomeFattorino();
            aggiungiCampoCliente(); 

            const giroAttivo = localStorage.getItem('giroAttivo') === 'true';
            if (giroAttivo) {
                aggiornaUIGiroInCorso();
            } else {
                aggiornaUINessunGiro();
            }
            caricaCronologia();
        }

        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
